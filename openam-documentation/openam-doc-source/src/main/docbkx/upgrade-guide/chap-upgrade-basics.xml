<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! src/main/resources/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2013 ForgeRock, Inc.
  !    
-->
<chapter xml:id='chap-upgrade-basics'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Upgrading Basics</title>
 <indexterm><primary>Upgrading</primary></indexterm>

 <para>This chapter shows you how to upgrade OpenAM core services. Starting
 with OpenAM 10.0.0 and later versions, OpenAM supports schema changes as 
 part of an upgrade, so you may need to run the upgrade wizard at the end of the 
 upgrade process. The wizard will automatically write all necessary changes to the 
 configuration store and will prompt you to restart the container.</para>
 
 <para>There are two ways to upgrade your deployment: using the defaults and 
 adding the customized files. You should try the default upgrade in a test
 environment before you apply it to a production environment. ForgeRock also
 recommends working on the customized version in a test environment before
 updating a productions version so that you will be aware of any potential
 issues that you may encounter with your customized version.</para>
 
<!-- TO DO <para>Working with multiple instances of OpenAM requires some variations to 
 the procedures, as noted below. An additional procedure is included if you 
 want to complete an upgrade without downtime.</para>
 -->
 <note>
  <para>ForgeRock strongly recommend that you do not expose an OpenAM instance to
  users during the upgrade process since running the wizard does not require
  authorization.</para>
 </note>

<!--
 <note>
  <para>Following an update to OpenAM 10.1.0, all users will
  need to login again because OpenAM no longer uses Open Message Queue or 
  Berkeley DB Java Edition for session failover. </para>
 </note>
 -->
 <procedure xml:id="upgrade-procedure">
  <title>To Upgrade From OpenAM 9.1 Or Later</title>
  
  <para>ForgeRock has considerably simplified OpenAM core services upgrade
  with respect to earlier versions. If you have one instance that is OpenAM 9.1
  or later, these steps will walk you through adding your customized content
  into the deployable <filename>.war</filename> file and upgrading to the 
  next version of OpenAM.</para>
  
  <step>
   <para>Verify that the JAVA_HOME is properly set.</para>
  </step>

  <step>
   <para><link xlink:href="upgrade-guide#chap-custom"
     xlink:role="http://docbook.org/xlink/role/olink">
     <citetitle>Customize</citetitle></link> your deployment if desired.</para>
  </step>

  <step>
   <para>Backup the file system directory for the current deployment.</para>
   
   <para>If you have multiple instances deployed, all instances must be running
   when you backup.</para>
  </step>

  <step>
   <para>Backup the configuration data.</para>
   
   <para>If you have multiple instances deployed, all instances must be running
   when you backup.</para>
  </step>

  <step>
   <para>Export the configuration backend/DN from the directory server.</para>
  </step>

  <step>
   <para>Copy the configuration directory.</para>
  </step>

  <step>
   <para>Stop OpenAM, or if necessary to redeploy OpenAM, stop the container 
   where OpenAM is running.</para>
  </step>
  
  <step>
   <para>Deploy the customized upgrade <filename>.war</filename> file.</para>
   
   <para>If you have multiple instance, you will need to deploy the upgrade 
   <filename>.war</filename> file for all of your OpenAM instances.</para>
  </step>

  <step>
   <para>Restart your container.</para>
  </step>

  <step>
   <para>For the first instance, follow the instructions in the upgrade wizard 
   if you are applying upgrades to OpenAM 10.0.0 or later. If you prefer, you can use
   the upgrade.jar from the command line to complete the upgrade process.</para>
  </step>

  <step>
   <para>If you downloaded the <filename>.zip</filename> file to upgrade the tools,
   reinstall them.</para>
  </step>
  <step>
   <para>If OpenAM is running in a site deployment with multiple servers,
   configure your load balancer to take the OpenAM server out of the site
   pool during upgrade.</para>
  </step>

 </procedure>

 <example xml:id="upgrade-example">
 <?dbfo keep-together="auto"?>
  <title>Upgrading to OpenAM 10.0.0</title>
  <para>The following example upgrades OpenAM 9.5.5 to OpenAM 10.0.0 on an Ubuntu
  instance using Apache Tomcat. <!-- TO DO The Deployment Guide provides more information for other 
  containers and platforms.--> The example only addresses the <filename>.war</filename>
  file. Review the <citetitle>Installation Guide</citetitle> to reinstall the tools 
  following a successful upgrade.</para>
  
  <para>Your port numbers and directory names may be different than the ones
  used in the example. Also, make sure to use your password where applicable.</para>
  
  <para>If you have multiple instances, make sure they are all running during the 
  backup process.</para>
  
  <orderedlist numeration="arabic">
  <listitem>
   <para>Verify that the JAVA_HOME is properly set.</para>
   <screen>echo $JAVA_HOME
 /path/to/java</screen>
  </listitem>

  <listitem>
   <para><link xlink:href="upgrade-guide#chap-custom"
     xlink:role="http://docbook.org/xlink/role/olink">
     <citetitle>Customize</citetitle></link> your deployment if desired.</para>
  </listitem>

  <listitem>
    <para>Backup the current deployment directory.</para>
    <screen>cp -r /path/to/openam /path/to/backup</screen>
  </listitem>

  <listitem>
   <para>Backup the configuration data.</para>
   <screen>$ cd /path/to/ssoadm-home/openam/bin
$ ./ssoadm export -svc-cfg --adminid amadmin --password-file path/to/password/file 
 --encryptsecret mySeretEncryptionKey --outfile openam-config-export.xml</screen>
  </listitem>

  <listitem>
   <para>Export the configuration backend/DN from the directory server.</para>
   <screen>$ cd /path/to/directory-server-home/bin/
$ ./backup --port 4444 --bindDN 'cn=Directory Manager" --bindPassword password 
 -- backendID userRoot --backupDirectory /path/to/backup-directory --start 0</screen>
  </listitem>

  <listitem>
   <para>Copy the configuration directory.</para>
   <screen>$ tar -czvf openam-home.tar.gz path/to/openam-home</screen>
  </listitem>

  <listitem>
    <para>Shutdown Tomcat.</para>
    <screen>$ cd /path/to/tomcat
$ ./bin/shutdown.sh

Password:
 Using CATALINA_BASE:   /path/to/tomcat
 Using CATALINA_HOME:   /path/to/tomcat
 Using CATALINA_TMPDIR: /path/to/tomcat/temp
 Using JRE_HOME:        /path/to/jdk/jre
 Using CLASSPATH:       /path/to/tomcat/bin/bootstrap.jar</screen>
  </listitem>

  <listitem>
   <para>Deploy the customized upgrade <filename>.war</filename> file.</para>
   <screen>$ cd /path/to/tomcat/webapps
$ rm -rf openam
$ rm openam.war
$ rm -rf /path/to/tomcat/work/Catalina/localhost/openam
$ cp /path/to/expanded-openam-war/upgrade-war/openam.war .</screen>
  </listitem>

  <listitem>
   <para>Restart Tomcat.</para>
   <screen>$ cd..
$ ./bin/startup.sh</screen>
  </listitem>

  <listitem>
   <para>In your browser, go to your instance of OpenAM and follow the 
   instructions in the upgrade wizard.</para>
    <mediaobject xml:id="figure-upgrade-initial-screen">
    <alt>Initial OpenAM upgrade screen</alt>
    <imageobject>
     <imagedata fileref="images/upgrade-initial-screen.png" format="PNG" />
    </imageobject>
    <textobject><para>The initial upgrade screen lets you choose to upgrade
     or to restore the configuration.</para></textobject>
   </mediaobject>
    <mediaobject xml:id="figure-upgrade-report">
    <alt>Initial OpenAM upgrade screen</alt>
    <imageobject>
     <imagedata fileref="images/upgrade-report.png" format="PNG" />
    </imageobject>
    <textobject><para>The initial upgrade screen lets you choose to upgrade
     or to restore the configuration.</para></textobject>
   </mediaobject>
  </listitem>
  
  <listitem>
   <para>Reinstall any tools you would like to have with the upgraded version
   of OpenAM. Refer to the <link xlink:href="http://openam.forgerock.org">
   <citetitle>Installation Guide</citetitle></link> if you are unsure how
   to reinstall the tools.</para>
  </listitem>

  <listitem>
   <para>If OpenAM is running in a site deployment with multiple servers,
   configure your load balancer to take the OpenAM server out of the site
   pool during upgrade.</para>
  </listitem>
  </orderedlist>

  <para>Once you have verified that the deployment is complete, you can
  go back and delete the directories your created to expand the 
  <filename>.war</filename> files.</para>

 </example>

<!--  Needs testing
 <procedure xml:id="upgrade-multiple-instances-procedure">
  <title>Upgrading Multiple OpenAM Instances To OpenAM 10.0.0 Without Downtime</title>
  <para>If you need to keep all of your instances of OpenAM up and running
  you can upgrade all of them without having any lapse in service. If you have
  a functional session failover system, user sessions will be preserved throughout
  and after the upgrade process.</para>

  <para>If you need to reinstall the session tools, a cold restart of the session 
  failover system is required. This means that all sessions will be stopped from 
  the session database cluster, and most or all of your users will lose their 
  active sessions and will need to login again. ForgeRock advise you to carry out a complete
  upgrade with the tools in a maintenance window.</para>
  
  <para>If the internal representation of session objects is significantly changed
  between versions ForgeRock recommends you preform a cold restart of your session 
  failover cluster to remove old sessions.</para>
  
  <para>If you are upgrading all of your instances without upgrading the tools,
  use the following procedure to upgrade without any downtime for your users.
  The procedure is based four servers (A, B, C, and D).</para>
  
  <step>
   <para>Remove servers A and B from the load balancer.</para>
  </step>
  
  <step>
   <para>Break the following replication agreements in OpenDJ so that you will
   have two separate OpenDJ clusters: A(C,D); B(C,D); C(A,B); D(A,B).</para>
  </step>

  <step>
   <para>Stop servers A and B.</para>
  </step>

  <step>
   <para>Follow the instructions upgrading an instance for servers A and 
   restart it.</para>
  </step>

  <step>
   <para>Run the upgrade wizard and restart servers A.</para>
  </step>

  <step>
   <para>Follow the instructions upgrading an instance for servers B and 
   restart it. You will not need to run the upgrade wizard since it
   will automatically replicate the configuration from servers A.</para>
  </step>

  <step>
   <para>Add servers A and B back to the load balancer and remove servers
   C and D.</para>
  </step>

  <step>
   <para>Stop servers C and D.</para>
  </step>

  <step>
   <para>Follow the instructions upgrading an instance for servers C and 
   restart it. You will not need to run the upgrade wizard.</para>
  </step>
 
  <step>
   <para>Follow the instructions upgrading an instance for servers D and 
   restart it. You will not need to run the upgrade wizard.</para>
  </step>
  
  <step>
   <para>Enable replication between all of the nodes.</para>
  </step>

  <step>
   <para>Add servers C and D back to the load balancer.</para>
  </step>

 </procedure>
-->
</chapter>


