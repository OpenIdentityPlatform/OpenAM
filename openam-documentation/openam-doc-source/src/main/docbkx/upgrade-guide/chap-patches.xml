<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! src/main/resources/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2013 ForgeRock, Inc.
  !    
-->
<chapter xml:id='chap-patches'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Applying a Patch</title>
 <indexterm><primary>Patches</primary></indexterm>

 <para>This chapter describes how to apply a patch and provides an example. It also
 provides information to update for your unique patch files, including changes
 for Java class files and other resources that you may want to periodically replace
 or add to your OpenAM web application. Class loading is implemented slightly 
 differently by each servlet container. Some containers require you to apply a patch to 
 an already deployed web application. For these containers, you can apply the patch 
 like an update. Some containers will require that you always follow these steps to  
 apply patches. ForgeRock strongly recommend that you rebuild the <filename>.war</filename> 
 file to apply patches in a production environment.  </para>
 
   <note>
    <para>For all tested containers, it is best to extract class files from 
    the patch to the <literal>/path/to/expanded/war/WEB-INF/classes</literal>
    directory. This directory takes precedence over class libraries in the
    <literal>WEB-INF/lib</literal>.</para>
   </note>
  
 <procedure xml:id="update-patch">
  <title>To Apply a Patch</title>

<!--
  <para><literal>Should patch files include backups for the backen/DN and the 
  config directory? Omissions of those steps is currently the only real difference 
  between the patch chapter and the update chapter.</literal></para>
  -->
  <para>Follow these steps on each OpenAM server to apply a patch.</para>
  
  <step>
   <para>Verify that the JAVA_HOME is properly set.</para>
  </step>
  
  <step>
   <para><link xlink:href="upgrade-guide#chap-custom"
     xlink:role="http://docbook.org/xlink/role/olink">
     <citetitle>Customize</citetitle></link> your deployment if desired.</para>
  </step>

  <step>
   <para>Backup the file system directory for the current deployment.</para>
  </step>

  <step>
   <para>Stop OpenAM, or if necessary to redeploy OpenAM, stop the container 
   where OpenAM is running.</para>
  </step>
  
  <step>
   <para>Deploy the customized patch <filename>.war</filename> file. You will need
   to deploy the patch <filename>.war</filename> file for all of your OpenAM
   instances.</para>
  </step>

  <step>
   <para>Restart your container.</para>
  </step>

  <step>
   <para>Follow the instructions in the upgrade wizard if you are applying patches
   to OpenAM 10.0.0 or later.</para>
  </step>
 </procedure>

 <example xml:id="patch-example">
 <?dbfo keep-together="auto"?>
  <title>Applying OpenAM 10.0.1</title>
  <para>The following example applies the OpenAM 10.0.1 patch release to OpenAM 10.0.0 
  on an Ubuntu instance. <!-- TO DO The <citetitle>Deployment Guide</citetitle> provides more 
  information for other containers and platforms.--></para>
  
  <orderedlist numeration="arabic">
  <listitem>
   <para>Verify that the JAVA_HOME is properly set.</para>
   <screen>echo $JAVA_HOME
 /path/to/java</screen>
  </listitem>

  <listitem>
   <para><link xlink:href="upgrade-guide#chap-custom"
     xlink:role="http://docbook.org/xlink/role/olink">
     <citetitle>Customize</citetitle></link> your deployment if desired.</para>
  </listitem>

  <listitem>
    <para>Backup the current deployment directory.</para>
    <screen>cp -r /path/to/tomcat/webapps/openam /path/to/backup</screen>
  </listitem>

  <listitem>
    <para>Shutdown Tomcat.</para>
    <screen>$ cd /path/to/tomcat
$ ./bin/shutdown.sh

Password:
 Using CATALINA_BASE:   /path/to/tomcat
 Using CATALINA_HOME:   /path/to/tomcat
 Using CATALINA_TMPDIR: /path/to/tomcat/temp
 Using JRE_HOME:        /path/to/jdk/jre
 Using CLASSPATH:       /path/to/tomcat/bin/bootstrap.jar</screen>
  </listitem>

  <listitem>
   <para>Deploy the customized patch <filename>.war</filename> file.</para>
   <screen>$ cd /path/to/tomcat/webapps
$ rm openam.war
$ rm -rf /path/to/tomcat/work/Catalina/localhost/openam
$ cp /path/to/expanded-openam-war/patch-war/openam.war .</screen>
  </listitem>

  <listitem>
   <para>Restart Tomcat.</para>
   <screen>$ cd..
$ ./bin/startup.sh</screen>
  </listitem>

  <listitem>
   <para>In your browser, go to your instance of OpenAM and follow the 
   instructions in the upgrade wizard.</para>
  </listitem>
  
 </orderedlist>
 
  <para>Once you have verified that the deployment is complete, you can
  go back and delete the directories your created to expand the 
  <filename>.war</filename> files.</para>

 </example>

 <procedure xml:id="update-class-patch">
  <title>To Apply a Unique Patch</title>

   <para>Because these files will be specific to your instance, basic Tomcat 
   instructions are provided to help clarify some steps instead of creating a 
   separate example.</para>
   
  <step>
   <para>Backup the file system directory for the current deployment.</para>
  </step>

  <step>
   <para>Create a new directory and expand your current <filename>.war</filename> file.
   You will be copying the <filename>patch.jar</filename> or class files directly into 
   this area.</para>
   <screen>$ cd /desired/location/for/expanding/files
$ mkdir expanded-openam-war ; cd expanded-openam-war
$ jar xvf /patch/to/tomcat/webapps/openam.war</screen>
  </step>

  <step>
  <para>Go to the <literal>class</literal> directory.</para>
  <screen>$ cd WEB-INF/classes</screen>
  </step>
 
  <step>
   <para>Open the <filename>patch.jar</filename> file or any applicable class files
   you want to replace in this area.</para>
   <screen>$ jar xvf /path/to/saved/patch.jar</screen>
  </step>
  
  <step>
   <para>Return to the <literal>expanded-openam-war</literal> area.</para>
   <screen>$ cd ../..</screen>
  </step>

  <step>
   <para>Rebuild the <filename>.war</filename> file.</para>
   <screen>$ jar cvf openam-patched.war *</screen>
  </step>

  <step>
   <para>Deploy the customized patch <filename>.war</filename> file on each OpenAM
   server, replacing the previous version.</para>
  </step>

 </procedure>

</chapter>
