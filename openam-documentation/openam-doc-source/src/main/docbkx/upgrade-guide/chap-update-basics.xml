<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! src/main/resources/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2013 ForgeRock, Inc.
  !    
-->
<chapter xml:id='chap-update-basics'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Updating Basics</title>
 <indexterm><primary>Updating</primary></indexterm>
 
<!-- TO DO analyze update process for other war files -->
 <para>This chapter shows you how to update an OpenAM server. Starting
 with OpenAM 10.0.0 and later versions, OpenAM supports schema changes as 
 part of an update, so you may need to run the upgrade wizard at the end of the 
 update process. The wizard will automatically write all necessary changes to the 
 configuration store and will prompt you to restart the container.</para>
 
 <para>There are two ways to update your deployment: using the defaults and 
 adding the customized files. You should try the default update in a test
 environment before you apply it to a production environment. ForgeRock also
 recommends working on the customized version in a test environment before
 updating a productions version so that you will be aware of any potential
 issues that you may encounter with your customized version.</para>
  
 <para>These instructions are good for updates from OpenAM 9.5 to any later
 OpenAM 9.X release, and updates from 10.0.0 to any later OpenAM 10.x release.</para>

<!--
 <note>
  <para>Following an update to OpenAM 10.1.0, all users will
  need to login again because OpenAM no longer uses Open Message Queue or 
  Berkeley DB Java Edition for session failover. </para>
 </note>
 -->

 <procedure xml:id="update-procedures">
  <title>To Update With The Default</title>
  
  <step>
   <para>Verify that the JAVA_HOME is properly set.</para>
  </step>

  <step>
   <para><link xlink:href="upgrade-guide#chap-custom"
     xlink:role="http://docbook.org/xlink/role/olink">
     <citetitle>Customize</citetitle></link> your deployment if desired.</para>
  </step>

  <step>
   <para>Backup the file system directory for the current deployment.</para>
   
   <para>If you have multiple instances deployed, all instances must be running
   when you backup.</para>
  </step>

  <step>
   <para>Backup the configuration data.</para>
   
   <para>If you have multiple instances deployed, all instances must be running
   when you backup.</para>
  </step>

  <step>
   <para>Export the configuration backend where OpenAM configuration data is stored.
   By default the base DN for the backend is <?eval ${defaultRootSuffix}?>.</para>
  </step>

  <step>
   <para>Copy the configuration directory.</para>
  </step>

  <step>
   <para>Stop OpenAM, or if necessary to redeploy OpenAM, stop the container 
   where OpenAM is running.</para>
  </step>
  
  <step>
   <para>Deploy the customized update <filename>.war</filename> file.</para>
   
   <para>If you have multiple instance, you will need to deploy the update 
   <filename>.war</filename> file for all of your OpenAM instances.</para>
  </step>

  <step>
   <para>Restart your container, as applicable.</para>
  </step>

  <step>
   <para>For the first instance, follow the instructions in the upgrade wizard 
   if you are applying updates to OpenAM 10.0.0 or later. </para>
  </step>

  <step>
   <para>If you downloaded the <filename>.zip</filename> file to update the tools,
   reinstall them.</para>
  </step>

 </procedure>

 <example xml:id="udpate-example">
 <?dbfo keep-together="auto"?>
  <title>Updating to OpenAM 10.1.0</title>
  <para>The following example updates OpenAM 10.0.0 to OpenAM 10.1.0 on an 
  Ubuntu instance using Apache Tomcat. <!-- TO DO The <citetitle>Deployment Guide</citetitle> provides more 
  information for other containers and platforms.--> The example only addresses the 
  <filename>.war</filename> file. Review the <citetitle>Installation Guide</citetitle> 
  to reinstall the tools following a successful update.</para>
  
  <para>Your port numbers and directory names may be different than the ones
  used in the example. Also, make sure to use your password where applicable.</para>
  
  <para>If you have multiple instances, make sure they are all running during the 
  backup process.</para>
  
  <orderedlist numeration="arabic">
  <listitem>
   <para>Verify that the JAVA_HOME is properly set.</para>
   <screen>echo $JAVA_HOME
 /path/to/java-6-sun</screen>
  </listitem>

  <listitem>
   <para><link xlink:href="upgrade-guide#chap-custom"
     xlink:role="http://docbook.org/xlink/role/olink">
     <citetitle>Customize</citetitle></link> your deployment if desired.</para>
  </listitem>

  <listitem>
    <para>Backup the current deployment directory.</para>
    <screen>cp -r /path/to/openam /path/to/backup</screen>
  </listitem>

  <listitem>
   <para>Backup the configuration data.</para>
   <screen>$ cd /path/to/ssoadm-home/openam/bin
$ ./ssoadm export -svc-cfg --adminid amadmin --password-file path/to/password/file 
 --encryptsecret mySeretEncryptionKey --outfile openam-config-export.xml</screen>
  </listitem>

  <listitem>
   <para>Export the configuration backend/DN from the directory server.</para>
   <screen>$ cd /path/to/directory-server-home/bin/
$ ./backup --port 4444 --bindDN 'cn=Directory Manager" --bindPassword password 
 -- backendID userRoot --backupDirectory /path/to/backup-directory --start 0</screen>
  </listitem>

  <listitem>
   <para>Copy the configuration directory.</para>
   <screen>$ tar -czvf openam-home.tar.gz path/to/openam-home</screen>
  </listitem>

  <listitem>
    <para>Shutdown Tomcat.</para>
    <screen>$ cd /path/to/tomcat
$ ./bin/shutdown.sh

Password:
 Using CATALINA_BASE:   /path/to/tomcat
 Using CATALINA_HOME:   /path/to/tomcat
 Using CATALINA_TMPDIR: /path/to/tomcat/temp
 Using JRE_HOME:        /path/to/jdk/jre
 Using CLASSPATH:       /path/to/tomcat/bin/bootstrap.jar</screen>
  </listitem>

  <listitem>
   <para>Deploy the customized update <filename>.war</filename> file.</para>
   <screen>$ cd /path/to/tomcat/webapps
$ rm -rf openam
$ rm openam.war
$ rm -rf /path/to/tomcat/work/Catalina/localhost/openam
$ cp /path/to/expanded-openam-war/update-war/openam.war .</screen>
  </listitem>

  <listitem>
   <para>Restart Tomcat.</para>
   <screen>$ cd..
$ ./bin/startup.sh</screen>
  </listitem>

  <listitem>
   <para>In your browser, go to your instance of OpenAM and follow the 
   instructions in the upgrade wizard.</para>
    <mediaobject xml:id="figure-udate-initial-screen">
    <alt>Initial OpenAM upgrade screen</alt>
    <imageobject>
     <imagedata fileref="images/update-initial-screen.png" format="PNG" />
    </imageobject>
    <textobject><para>The initial upgrade screen lets you choose to upgrade
     or to restore the configuration.</para></textobject>
   </mediaobject>

    <mediaobject xml:id="figure-update-report">
    <alt>Initial OpenAM upgrade screen</alt>
    <imageobject>
     <imagedata fileref="images/update-report.png" format="PNG" />
    </imageobject>
    <textobject><para>The initial upgrade screen lets you choose to upgrade
     or to restore the configuration.</para></textobject>
   </mediaobject>
  </listitem>
  
  <listitem>
   <para>Reinstall any tools you would like to have with the updated version
   of OpenAM. Refer to the 
   <link xlink:href="http://openam.forgerock.org/openam-documentation/openam-doc-source/doc/install-guide/index.html">
   <citetitle>Installation Guide</citetitle></link> if you are unsure how
   to reinstall the tools.</para>
  </listitem>
 </orderedlist>

  <para>Once you have verified that the deployment is complete, you can
  go back and delete the directories your created to expand the 
  <filename>.war</filename> files.</para>

 </example>

</chapter>