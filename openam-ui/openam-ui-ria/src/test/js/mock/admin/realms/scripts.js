/**
 * The contents of this file are subject to the terms of the Common Development and
 * Distribution License (the License). You may not use this file except in compliance with the
 * License.
 *
 * You can obtain a copy of the License at legal/CDDLv1.0.txt. See the License for the
 * specific language governing permission and limitations under the License.
 *
 * When distributing Covered Software, include this CDDL Header Notice in each file and include
 * the License file at legal/CDDLv1.0.txt. If applicable, add the following below the CDDL
 * Header, with the fields enclosed by brackets [] replaced by your own identifying
 * information: "Portions copyright [year] [name of copyright owner]".
 *
 * Copyright 2015 ForgeRock AS.
 */

/*global define*/
define("mock/admin/realms/scripts", [
], function () {
    return function (server) {
        server.respondWith(
            "POST",
            /\/json\/global-config\/services\/scripting\?_action=schema$/,
            [
                200,
                { },
                JSON.stringify(
                    {
                        "properties": {
                            "defaultContext": {
                                "title": "Default Script Type",
                                "description": "The default script type selection.<br><br>The default script type that " +
                                    "will be selected when creating a new script.",
                                "propertyOrder": "g101",
                                "required": true,
                                "enum": ["POLICY_CONDITION", "AUTHENTICATION_SERVER_SIDE", "AUTHENTICATION_CLIENT_SIDE", "OIDC_CLAIMS", "SDK"],
                                "options": {
                                    "enum_titles": ["Policy Condition", "Server-side Authentication", "Client-side Authentication", "OIDC Claims", "SDK"]
                                }
                            }
                        }
                    }
                )
            ]
        );

        server.respondWith(
            "POST",
            /\/json\/global-config\/services\/scripting\/contexts\?_action=schema/,
            [
                200,
                { },
                JSON.stringify(
                    {
                        "properties": {
                            "languages": {
                                "title": "Scripting languages",
                                "description": "The language the script is written in.<br><br>This is used to determine " +
                                    "how to validate the script, as well as which engine to run the script within.",
                                "propertyOrder": "st101",
                                "required": true,
                                "items": {
                                    "type": "string",
                                    "enum": ["JAVASCRIPT", "GROOVY"],
                                    "options": {
                                        "enum_titles": ["JavaScript", "Groovy"]
                                    }
                                },
                                "type": "array"
                            },
                            "defaultScript": {
                                "title": "Default Script",
                                "description": "The default script for new scripts of this type.<br><br>This script " +
                                    "will be set as the default when a new script of this type is created.",
                                "propertyOrder": "st103",
                                "required": true,
                                "enum": ["3192f38e-00b1-473b-8de7-604c0f50d86d", "157298c0-7d31-4059-a95b-eeb08473b7e5",
                                    "9de3eb62-f131-4fac-a294-7bd170fd4acb", "7e3d7067-d50f-4674-8c76-a3e13a810c33",
                                    "703dab1a-1921-4981-98dd-b8e5349d8548", "36863ffb-40ec-48b9-94b1-9a99f71cc3b5",
                                    "862da73e-1beb-11e5-9a21-1697f925ec7b", "[Empty]"],
                                "options": {
                                    "enum_titles": ["ds", "Device Id (Match) - Client Side", "Scripted Policy Condition",
                                        "Scripted Module - Server Side", "Device Id (Match) - Server Side",
                                        "OIDC Claims Script", "SDK Script", "--- Select a script ---"]
                                }
                            }
                        }
                    }
                )
            ]
        );

        server.respondWith(
            "GET",
            /\/json\/global-config\/services\/scripting\/contexts\?_queryFilter=true/,
            [
                200,
                { },
                JSON.stringify(
                    {
                        "result": [
                            {"defaultScript": "9de3eb62-f131-4fac-a294-7bd170fd4acb", "languages": ["GROOVY", "JAVASCRIPT"], "_id": "POLICY_CONDITION"},
                            {"defaultScript": "7e3d7067-d50f-4674-8c76-a3e13a810c33", "languages": ["GROOVY", "JAVASCRIPT"], "_id": "AUTHENTICATION_SERVER_SIDE"},
                            {"defaultScript": "[Empty]", "languages": ["JAVASCRIPT"], "_id": "AUTHENTICATION_CLIENT_SIDE"},
                            {"defaultScript": "9de3eb62-f131-4fac-a294-7bd170fd4acb", "languages": ["GROOVY", "JAVASCRIPT"], "_id": "OIDC_CLAIMS"},
                            {"defaultScript": "862da73e-1beb-11e5-9a21-1697f925ec7b", "languages": ["GROOVY"], "_id": "SDK"}
                        ],
                        "resultCount": 5,
                        "pagedResultsCookie": null,
                        "remainingPagedResults": -1
                    }
                )
            ]
        );

        server.respondWith(
            "GET",
            /\/json\/scripts\?/,
            [
                200,
                { },
                JSON.stringify(
                    {"result": [
                        {"_id": "157298c0-7d31-4059-a95b-eeb08473b7e5", "name": "Device Id (Match) - Client Side", "description": "Default global script for client side Device Id (Match) Authentication Module", "script": "dmFyIGZvbnREZXRlY3RvciA9IChmdW5jdGlvbiAoKSB7CiAgICAvKioKICAgICAqIEphdmFTY3JpcHQgY29kZSB0byBkZXRlY3QgYXZhaWxhYmxlIGF2YWlsYWJpbGl0eSBvZiBhCiAgICAgKiBwYXJ0aWN1bGFyIGZvbnQgaW4gYSBicm93c2VyIHVzaW5nIEphdmFTY3JpcHQgYW5kIENTUy4KICAgICAqCiAgICAgKiBBdXRob3IgOiBMYWxpdCBQYXRlbAogICAgICogV2Vic2l0ZTogaHR0cDovL3d3dy5sYWxpdC5vcmcvbGFiL2phdmFzY3JpcHQtY3NzLWZvbnQtZGV0ZWN0LwogICAgICogTGljZW5zZTogQXBhY2hlIFNvZnR3YXJlIExpY2Vuc2UgMi4wCiAgICAgKiAgICAgICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICAgICAqIFZlcnNpb246IDAuMTUgKDIxIFNlcCAyMDA5KQogICAgICogICAgICAgICAgQ2hhbmdlZCBjb21wYXJpc2lvbiBmb250IHRvIGRlZmF1bHQgZnJvbSBzYW5zLWRlZmF1bHQtZGVmYXVsdCwKICAgICAqICAgICAgICAgIGFzIGluIEZGMy4wIGZvbnQgb2YgY2hpbGQgZWxlbWVudCBkaWRuJ3QgZmFsbGJhY2sKICAgICAqICAgICAgICAgIHRvIHBhcmVudCBlbGVtZW50IGlmIHRoZSBmb250IGlzIG1pc3NpbmcuCiAgICAgKiBWZXJzaW9uOiAwLjIgKDA0IE1hciAyMDEyKQogICAgICogICAgICAgICAgQ29tcGFyaW5nIGZvbnQgYWdhaW5zdCBhbGwgdGhlIDMgZ2VuZXJpYyBmb250IGZhbWlsaWVzIGllLAogICAgICogICAgICAgICAgJ21vbm9zcGFjZScsICdzYW5zLXNlcmlmJyBhbmQgJ3NhbnMnLiBJZiBpdCBkb2Vzbid0IG1hdGNoIGFsbCAzCiAgICAgKiAgICAgICAgICB0aGVuIHRoYXQgZm9udCBpcyAxMDAlIG5vdCBhdmFpbGFibGUgaW4gdGhlIHN5c3RlbQogICAgICogVmVyc2lvbjogMC4zICgyNCBNYXIgMjAxMikKICAgICAqICAgICAgICAgIFJlcGxhY2VkIHNhbnMgd2l0aCBzZXJpZiBpbiB0aGUgbGlzdCBvZiBiYXNlRm9udHMKICAgICAqLwogICAgLyoKICAgICAqIFBvcnRpb25zIENvcHlyaWdodGVkIDIwMTMgRm9yZ2VSb2NrIEFTLgogICAgICovCiAgICB2YXIgZGV0ZWN0b3IgPSB7fSwgYmFzZUZvbnRzLCB0ZXN0U3RyaW5nLCB0ZXN0U2l6ZSwgaCwgcywgZGVmYXVsdFdpZHRoID0ge30sIGRlZmF1bHRIZWlnaHQgPSB7fSwgaW5kZXg7CgogICAgLy8gYSBmb250IHdpbGwgYmUgY29tcGFyZWQgYWdhaW5zdCBhbGwgdGhlIHRocmVlIGRlZmF1bHQgZm9udHMuCiAgICAvLyBhbmQgaWYgaXQgZG9lc24ndCBtYXRjaCBhbGwgMyB0aGVuIHRoYXQgZm9udCBpcyBub3QgYXZhaWxhYmxlLgogICAgYmFzZUZvbnRzID0gWydtb25vc3BhY2UnLCAnc2Fucy1zZXJpZicsICdzZXJpZiddOwoKICAgIC8vd2UgdXNlIG0gb3IgdyBiZWNhdXNlIHRoZXNlIHR3byBjaGFyYWN0ZXJzIHRha2UgdXAgdGhlIG1heGltdW0gd2lkdGguCiAgICAvLyBBbmQgd2UgdXNlIGEgTExpIHNvIHRoYXQgdGhlIHNhbWUgbWF0Y2hpbmcgZm9udHMgY2FuIGdldCBzZXBhcmF0ZWQKICAgIHRlc3RTdHJpbmcgPSAibW1tbW1tbW1tbWxsaSI7CgogICAgLy93ZSB0ZXN0IHVzaW5nIDcycHggZm9udCBzaXplLCB3ZSBtYXkgdXNlIGFueSBzaXplLiBJIGd1ZXNzIGxhcmdlciB0aGUgYmV0dGVyLgogICAgdGVzdFNpemUgPSAnNzJweCc7CgogICAgaCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF07CgogICAgLy8gY3JlYXRlIGEgU1BBTiBpbiB0aGUgZG9jdW1lbnQgdG8gZ2V0IHRoZSB3aWR0aCBvZiB0aGUgdGV4dCB3ZSB1c2UgdG8gdGVzdAogICAgcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIHMuc3R5bGUuZm9udFNpemUgPSB0ZXN0U2l6ZTsKICAgIHMuaW5uZXJIVE1MID0gdGVzdFN0cmluZzsKICAgIGZvciAoaW5kZXggaW4gYmFzZUZvbnRzKSB7CiAgICAgICAgLy9nZXQgdGhlIGRlZmF1bHQgd2lkdGggZm9yIHRoZSB0aHJlZSBiYXNlIGZvbnRzCiAgICAgICAgcy5zdHlsZS5mb250RmFtaWx5ID0gYmFzZUZvbnRzW2luZGV4XTsKICAgICAgICBoLmFwcGVuZENoaWxkKHMpOwogICAgICAgIGRlZmF1bHRXaWR0aFtiYXNlRm9udHNbaW5kZXhdXSA9IHMub2Zmc2V0V2lkdGg7IC8vd2lkdGggZm9yIHRoZSBkZWZhdWx0IGZvbnQKICAgICAgICBkZWZhdWx0SGVpZ2h0W2Jhc2VGb250c1tpbmRleF1dID0gcy5vZmZzZXRIZWlnaHQ7IC8vaGVpZ2h0IGZvciB0aGUgZGVmdWFsdCBmb250CiAgICAgICAgaC5yZW1vdmVDaGlsZChzKTsKICAgIH0KCiAgICBkZXRlY3Rvci5kZXRlY3QgPSBmdW5jdGlvbihmb250KSB7CiAgICAgICAgdmFyIGRldGVjdGVkID0gZmFsc2UsIGluZGV4LCBtYXRjaGVkOwogICAgICAgIGZvciAoaW5kZXggaW4gYmFzZUZvbnRzKSB7CiAgICAgICAgICAgIHMuc3R5bGUuZm9udEZhbWlseSA9IGZvbnQgKyAnLCcgKyBiYXNlRm9udHNbaW5kZXhdOyAvLyBuYW1lIG9mIHRoZSBmb250IGFsb25nIHdpdGggdGhlIGJhc2UgZm9udCBmb3IgZmFsbGJhY2suCiAgICAgICAgICAgIGguYXBwZW5kQ2hpbGQocyk7CiAgICAgICAgICAgIG1hdGNoZWQgPSAocy5vZmZzZXRXaWR0aCAhPT0gZGVmYXVsdFdpZHRoW2Jhc2VGb250c1tpbmRleF1dIHx8IHMub2Zmc2V0SGVpZ2h0ICE9PSBkZWZhdWx0SGVpZ2h0W2Jhc2VGb250c1tpbmRleF1dKTsKICAgICAgICAgICAgaC5yZW1vdmVDaGlsZChzKTsKICAgICAgICAgICAgZGV0ZWN0ZWQgPSBkZXRlY3RlZCB8fCBtYXRjaGVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGV0ZWN0ZWQ7CiAgICB9OwoKICAgIHJldHVybiBkZXRlY3RvcjsKfSgpKTsKLyoKICogRE8gTk9UIEFMVEVSIE9SIFJFTU9WRSBDT1BZUklHSFQgTk9USUNFUyBPUiBUSElTIEhFQURFUi4KICoKICogQ29weXJpZ2h0IChjKSAyMDA5IFN1biBNaWNyb3N5c3RlbXMgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIHRlcm1zCiAqIG9mIHRoZSBDb21tb24gRGV2ZWxvcG1lbnQgYW5kIERpc3RyaWJ1dGlvbiBMaWNlbnNlCiAqICh0aGUgTGljZW5zZSkuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICoKICogWW91IGNhbiBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHBzOi8vb3BlbnNzby5kZXYuamF2YS5uZXQvcHVibGljL0NEREx2MS4wLmh0bWwgb3IKICogb3BlbnNzby9sZWdhbC9DRERMdjEuMC50eHQKICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nCiAqIHBlcm1pc3Npb24gYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBXaGVuIGRpc3RyaWJ1dGluZyBDb3ZlcmVkIENvZGUsIGluY2x1ZGUgdGhpcyBDRERMCiAqIEhlYWRlciBOb3RpY2UgaW4gZWFjaCBmaWxlIGFuZCBpbmNsdWRlIHRoZSBMaWNlbnNlIGZpbGUKICogYXQgb3BlbnNzby9sZWdhbC9DRERMdjEuMC50eHQuCiAqIElmIGFwcGxpY2FibGUsIGFkZCB0aGUgZm9sbG93aW5nIGJlbG93IHRoZSBDRERMIEhlYWRlciwKICogd2l0aCB0aGUgZmllbGRzIGVuY2xvc2VkIGJ5IGJyYWNrZXRzIFtdIHJlcGxhY2VkIGJ5CiAqIHlvdXIgb3duIGlkZW50aWZ5aW5nIGluZm9ybWF0aW9uOgogKiAiUG9ydGlvbnMgQ29weXJpZ2h0ZWQgW3llYXJdIFtuYW1lIG9mIGNvcHlyaWdodCBvd25lcl0iCiAqCiAqLwovKgogKiBQb3J0aW9ucyBDb3B5cmlnaHRlZCAyMDEzIFN5bnRlZ3JpdHkuCiAqIFBvcnRpb25zIENvcHlyaWdodGVkIDIwMTMtMjAxNCBGb3JnZVJvY2sgQVMuCiAqLwoKdmFyIGNvbGxlY3RTY3JlZW5JbmZvID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzY3JlZW5JbmZvID0ge307CiAgICAgICAgaWYgKHNjcmVlbikgewogICAgICAgICAgICBpZiAoc2NyZWVuLndpZHRoKSB7CiAgICAgICAgICAgICAgICBzY3JlZW5JbmZvLnNjcmVlbldpZHRoID0gc2NyZWVuLndpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2NyZWVuLmhlaWdodCkgewogICAgICAgICAgICAgICAgc2NyZWVuSW5mby5zY3JlZW5IZWlnaHQgPSBzY3JlZW4uaGVpZ2h0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2NyZWVuLnBpeGVsRGVwdGgpIHsKICAgICAgICAgICAgICAgIHNjcmVlbkluZm8uc2NyZWVuQ29sb3VyRGVwdGggPSBzY3JlZW4ucGl4ZWxEZXB0aDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiQ2Fubm90IGNvbGxlY3Qgc2NyZWVuIGluZm9ybWF0aW9uLiBzY3JlZW4gaXMgbm90IGRlZmluZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzY3JlZW5JbmZvOwogICAgfSwKICAgIGNvbGxlY3RUaW1lem9uZUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHRpbWV6b25lSW5mbyA9ICB7fSwgb2Zmc2V0ID0gbmV3IERhdGUoKS5nZXRUaW1lem9uZU9mZnNldCgpOwoKICAgICAgICBpZiAob2Zmc2V0KSB7CiAgICAgICAgICAgIHRpbWV6b25lSW5mby50aW1lem9uZSA9IG9mZnNldDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIkNhbm5vdCBjb2xsZWN0IHRpbWV6b25lIGluZm9ybWF0aW9uLiB0aW1lem9uZSBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aW1lem9uZUluZm87CiAgICB9LAogICAgY29sbGVjdEJyb3dzZXJQbHVnaW5zSW5mbyA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IucGx1Z2lucykgewogICAgICAgICAgICB2YXIgcGx1Z2luc0luZm8gPSB7fSwgaSwgcGx1Z2lucyA9IG5hdmlnYXRvci5wbHVnaW5zOwogICAgICAgICAgICBwbHVnaW5zSW5mby5pbnN0YWxsZWRQbHVnaW5zID0gIiI7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGx1Z2lucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgcGx1Z2luc0luZm8uaW5zdGFsbGVkUGx1Z2lucyA9IHBsdWdpbnNJbmZvLmluc3RhbGxlZFBsdWdpbnMgKyBwbHVnaW5zW2ldLmZpbGVuYW1lICsgIjsiOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcGx1Z2luc0luZm87CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJDYW5ub3QgY29sbGVjdCBicm93c2VyIHBsdWdpbiBpbmZvcm1hdGlvbi4gbmF2aWdhdG9yLnBsdWdpbnMgaXMgbm90IGRlZmluZWQuIik7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICB9CgogICAgfSwKLy8gR2V0dGluZyBnZW9sb2NhdGlvbiB0YWtlcyBzb21lIHRpbWUgYW5kIGlzIGRvbmUgYXN5bmNocm9ub3VzbHksIGhlbmNlIG5lZWQgYSBjYWxsYmFjayB3aGljaCBpcyBjYWxsZWQgb25jZSBnZW9sb2NhdGlvbiBpcyByZXRyaWV2ZWQuCiAgICBjb2xsZWN0R2VvbG9jYXRpb25JbmZvID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIGdlb2xvY2F0aW9uSW5mbyA9IHt9LAogICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2sgPSBmdW5jdGlvbihwb3NpdGlvbikgewogICAgICAgICAgICAgICAgZ2VvbG9jYXRpb25JbmZvLmxvbmdpdHVkZSA9IHBvc2l0aW9uLmNvb3Jkcy5sb25naXR1ZGU7CiAgICAgICAgICAgICAgICBnZW9sb2NhdGlvbkluZm8ubGF0aXR1ZGUgPSBwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGU7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhnZW9sb2NhdGlvbkluZm8pOwogICAgICAgICAgICB9LCBlcnJvckNhbGxiYWNrID0gZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQ2Fubm90IGNvbGxlY3QgZ2VvbG9jYXRpb24gaW5mb3JtYXRpb24uICIgKyBlcnJvci5jb2RlICsgIjogIiArIGVycm9yLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgY2FsbGJhY2soZ2VvbG9jYXRpb25JbmZvKTsKICAgICAgICAgICAgfTsKICAgICAgICBpZiAobmF2aWdhdG9yICYmIG5hdmlnYXRvci5nZW9sb2NhdGlvbikgewogICAgICAgICAgICAvLyBOQjogSWYgdXNlciBjaG9vc2VzICdOb3Qgbm93JyBvbiBGaXJlZm94IG5laXRoZXIgY2FsbGJhY2sgZ2V0cyBjYWxsZWQKICAgICAgICAgICAgLy8gICAgIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY3NTUzMwogICAgICAgICAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjayk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJDYW5ub3QgY29sbGVjdCBnZW9sb2NhdGlvbiBpbmZvcm1hdGlvbi4gbmF2aWdhdG9yLmdlb2xvY2F0aW9uIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICAgICAgICBjYWxsYmFjayhnZW9sb2NhdGlvbkluZm8pOwogICAgICAgIH0KICAgIH0sCiAgICBjb2xsZWN0QnJvd3NlckZvbnRzSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZm9udHNJbmZvID0ge30sIGksIGZvbnRzTGlzdCA9IFsiY3Vyc2l2ZSIsIm1vbm9zcGFjZSIsInNlcmlmIiwic2Fucy1zZXJpZiIsImZhbnRhc3kiLCJkZWZhdWx0IiwiQXJpYWwiLCJBcmlhbCBCbGFjayIsCiAgICAgICAgICAgICJBcmlhbCBOYXJyb3ciLCJBcmlhbCBSb3VuZGVkIE1UIEJvbGQiLCJCb29rbWFuIE9sZCBTdHlsZSIsIkJyYWRsZXkgSGFuZCBJVEMiLCJDZW50dXJ5IiwiQ2VudHVyeSBHb3RoaWMiLAogICAgICAgICAgICAiQ29taWMgU2FucyBNUyIsIkNvdXJpZXIiLCJDb3VyaWVyIE5ldyIsIkdlb3JnaWEiLCJHZW50aXVtIiwiSW1wYWN0IiwiS2luZyIsIkx1Y2lkYSBDb25zb2xlIiwiTGFsaXQiLAogICAgICAgICAgICAiTW9kZW5hIiwiTW9ub3R5cGUgQ29yc2l2YSIsIlBhcHlydXMiLCJUYWhvbWEiLCJUZVgiLCJUaW1lcyIsIlRpbWVzIE5ldyBSb21hbiIsIlRyZWJ1Y2hldCBNUyIsIlZlcmRhbmEiLAogICAgICAgICAgICAiVmVyb25hIl07CiAgICAgICAgZm9udHNJbmZvLmluc3RhbGxlZEZvbnRzID0gIiI7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBmb250c0xpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGZvbnREZXRlY3Rvci5kZXRlY3QoZm9udHNMaXN0W2ldKSkgewogICAgICAgICAgICAgICAgZm9udHNJbmZvLmluc3RhbGxlZEZvbnRzID0gZm9udHNJbmZvLmluc3RhbGxlZEZvbnRzICsgZm9udHNMaXN0W2ldICsgIjsiOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmb250c0luZm87CiAgICB9LAogICAgZGV2aWNlUHJpbnQgPSB7fTsKCmRldmljZVByaW50LnNjcmVlbiA9IGNvbGxlY3RTY3JlZW5JbmZvKCk7CmRldmljZVByaW50LnRpbWV6b25lID0gY29sbGVjdFRpbWV6b25lSW5mbygpOwpkZXZpY2VQcmludC5wbHVnaW5zID0gY29sbGVjdEJyb3dzZXJQbHVnaW5zSW5mbygpOwpkZXZpY2VQcmludC5mb250cyA9IGNvbGxlY3RCcm93c2VyRm9udHNJbmZvKCk7CgppZiAobmF2aWdhdG9yLnVzZXJBZ2VudCkgewogICAgZGV2aWNlUHJpbnQudXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKfQppZiAobmF2aWdhdG9yLmFwcE5hbWUpIHsKICAgIGRldmljZVByaW50LmFwcE5hbWUgPSBuYXZpZ2F0b3IuYXBwTmFtZTsKfQppZiAobmF2aWdhdG9yLmFwcENvZGVOYW1lKSB7CiAgICBkZXZpY2VQcmludC5hcHBDb2RlTmFtZSA9IG5hdmlnYXRvci5hcHBDb2RlTmFtZTsKfQppZiAobmF2aWdhdG9yLmFwcFZlcnNpb24pIHsKICAgIGRldmljZVByaW50LmFwcFZlcnNpb24gPSBuYXZpZ2F0b3IuYXBwVmVyc2lvbjsKfQppZiAobmF2aWdhdG9yLmFwcE1pbm9yVmVyc2lvbikgewogICAgZGV2aWNlUHJpbnQuYXBwTWlub3JWZXJzaW9uID0gbmF2aWdhdG9yLmFwcE1pbm9yVmVyc2lvbjsKfQppZiAobmF2aWdhdG9yLmJ1aWxkSUQpIHsKICAgIGRldmljZVByaW50LmJ1aWxkSUQgPSBuYXZpZ2F0b3IuYnVpbGRJRDsKfQppZiAobmF2aWdhdG9yLnBsYXRmb3JtKSB7CiAgICBkZXZpY2VQcmludC5wbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybTsKfQppZiAobmF2aWdhdG9yLmNwdUNsYXNzKSB7CiAgICBkZXZpY2VQcmludC5jcHVDbGFzcyA9IG5hdmlnYXRvci5jcHVDbGFzczsKfQppZiAobmF2aWdhdG9yLm9zY3B1KSB7CiAgICBkZXZpY2VQcmludC5vc2NwdSA9IG5hdmlnYXRvci5vc2NwdTsKfQppZiAobmF2aWdhdG9yLnByb2R1Y3QpIHsKICAgIGRldmljZVByaW50LnByb2R1Y3QgPSBuYXZpZ2F0b3IucHJvZHVjdDsKfQppZiAobmF2aWdhdG9yLnByb2R1Y3RTdWIpIHsKICAgIGRldmljZVByaW50LnByb2R1Y3RTdWIgPSBuYXZpZ2F0b3IucHJvZHVjdFN1YjsKfQppZiAobmF2aWdhdG9yLnZlbmRvcikgewogICAgZGV2aWNlUHJpbnQudmVuZG9yID0gbmF2aWdhdG9yLnZlbmRvcjsKfQppZiAobmF2aWdhdG9yLnZlbmRvclN1YikgewogICAgZGV2aWNlUHJpbnQudmVuZG9yU3ViID0gbmF2aWdhdG9yLnZlbmRvclN1YjsKfQppZiAobmF2aWdhdG9yLmxhbmd1YWdlKSB7CiAgICBkZXZpY2VQcmludC5sYW5ndWFnZSA9IG5hdmlnYXRvci5sYW5ndWFnZTsKfQppZiAobmF2aWdhdG9yLnVzZXJMYW5ndWFnZSkgewogICAgZGV2aWNlUHJpbnQudXNlckxhbmd1YWdlID0gbmF2aWdhdG9yLnVzZXJMYW5ndWFnZTsKfQppZiAobmF2aWdhdG9yLmJyb3dzZXJMYW5ndWFnZSkgewogICAgZGV2aWNlUHJpbnQuYnJvd3Nlckxhbmd1YWdlID0gbmF2aWdhdG9yLmJyb3dzZXJMYW5ndWFnZTsKfQppZiAobmF2aWdhdG9yLnN5c3RlbUxhbmd1YWdlKSB7CiAgICBkZXZpY2VQcmludC5zeXN0ZW1MYW5ndWFnZSA9IG5hdmlnYXRvci5zeXN0ZW1MYW5ndWFnZTsKfQoKLy8gQXR0ZW1wdCB0byBjb2xsZWN0IGdlby1sb2NhdGlvbiBpbmZvcm1hdGlvbiBhbmQgcmV0dXJuIHRoaXMgd2l0aCB0aGUgZGF0YSBjb2xsZWN0ZWQgc28gZmFyLgovLyBPdGhlcndpc2UsIGlmIGdlby1sb2NhdGlvbiBmYWlscyBvciB0YWtlcyBsb25nZXIgdGhhbiAzMCBzZWNvbmRzLCBhdXRvLXN1Ym1pdCB0aGUgZGF0YSBjb2xsZWN0ZWQgc28gZmFyLgphdXRvU3VibWl0RGVsYXkgPSAzMDAwMDsKb3V0cHV0LnZhbHVlID0gSlNPTi5zdHJpbmdpZnkoZGV2aWNlUHJpbnQpOwpjb2xsZWN0R2VvbG9jYXRpb25JbmZvKGZ1bmN0aW9uKGdlb2xvY2F0aW9uSW5mbykgewogICAgZGV2aWNlUHJpbnQuZ2VvbG9jYXRpb24gPSBnZW9sb2NhdGlvbkluZm87CiAgICBvdXRwdXQudmFsdWUgPSBKU09OLnN0cmluZ2lmeShkZXZpY2VQcmludCk7CiAgICBzdWJtaXQoKTsKfSk7", "language": "JAVASCRIPT", "context": "AUTHENTICATION_CLIENT_SIDE", "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "creationDate": 1433147666269, "lastModifiedBy": "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org", "lastModifiedDate": 1438861282291},
                        {"_id": "703dab1a-1921-4981-98dd-b8e5349d8548", "name": "Device Id (Match) - Server Side", "description": "Default global script for server side Device Id (Match) Authentication Module", "script": "LyoKICogRE8gTk9UIEFMVEVSIE9SIFJFTU9WRSBDT1BZUklHSFQgTk9USUNFUyBPUiBUSElTIEhFQURFUi4KICoKICogQ29weXJpZ2h0IChjKSAyMDA5IFN1biBNaWNyb3N5c3RlbXMgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkCiAqCiAqIFRoZSBjb250ZW50cyBvZiB0aGlzIGZpbGUgYXJlIHN1YmplY3QgdG8gdGhlIHRlcm1zCiAqIG9mIHRoZSBDb21tb24gRGV2ZWxvcG1lbnQgYW5kIERpc3RyaWJ1dGlvbiBMaWNlbnNlCiAqICh0aGUgTGljZW5zZSkuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluCiAqIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICoKICogWW91IGNhbiBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHBzOi8vb3BlbnNzby5kZXYuamF2YS5uZXQvcHVibGljL0NEREx2MS4wLmh0bWwgb3IKICogb3BlbnNzby9sZWdhbC9DRERMdjEuMC50eHQKICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nCiAqIHBlcm1pc3Npb24gYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBXaGVuIGRpc3RyaWJ1dGluZyBDb3ZlcmVkIENvZGUsIGluY2x1ZGUgdGhpcyBDRERMCiAqIEhlYWRlciBOb3RpY2UgaW4gZWFjaCBmaWxlIGFuZCBpbmNsdWRlIHRoZSBMaWNlbnNlIGZpbGUKICogYXQgb3BlbnNzby9sZWdhbC9DRERMdjEuMC50eHQuCiAqIElmIGFwcGxpY2FibGUsIGFkZCB0aGUgZm9sbG93aW5nIGJlbG93IHRoZSBDRERMIEhlYWRlciwKICogd2l0aCB0aGUgZmllbGRzIGVuY2xvc2VkIGJ5IGJyYWNrZXRzIFtdIHJlcGxhY2VkIGJ5CiAqIHlvdXIgb3duIGlkZW50aWZ5aW5nIGluZm9ybWF0aW9uOgogKiAiUG9ydGlvbnMgQ29weXJpZ2h0ZWQgW3llYXJdIFtuYW1lIG9mIGNvcHlyaWdodCBvd25lcl0iCiAqCiAqLwovKgogKiBQb3J0aW9ucyBDb3B5cmlnaHRlZCAyMDEzIFN5bnRlZ3JpdHkuCiAqIFBvcnRpb25zIENvcHlyaWdodGVkIDIwMTMtMjAxNCBGb3JnZVJvY2sgQVMuCiAqLwoKdmFyIFNjYWxhckNvbXBhcmF0b3IgPSB7fSwgU2NyZWVuQ29tcGFyYXRvciA9IHt9LCBNdWx0aVZhbHVlQ29tcGFyYXRvciA9IHt9LCBVc2VyQWdlbnRDb21wYXJhdG9yID0ge30sIEdlb2xvY2F0aW9uQ29tcGFyYXRvciA9IHt9OwoKdmFyIGNvbmZpZyA9IHsKICAgIHByb2ZpbGVFeHBpcmF0aW9uOiAzMCwgICAgICAgICAgICAgIC8vaW4gZGF5cwogICAgbWF4UHJvZmlsZXNBbGxvd2VkOiA1LAogICAgbWF4UGVuYWx0eVBvaW50czogMCwKICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICBzY3JlZW46IHsKICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsCiAgICAgICAgICAgIGNvbXBhcmF0b3I6IFNjcmVlbkNvbXBhcmF0b3IsCiAgICAgICAgICAgIGFyZ3M6IHsKICAgICAgICAgICAgICAgIHBlbmFsdHlQb2ludHM6IDUwCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHBsdWdpbnM6IHsKICAgICAgICAgICAgaW5zdGFsbGVkUGx1Z2luczogewogICAgICAgICAgICAgICAgcmVxdWlyZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgY29tcGFyYXRvcjogTXVsdGlWYWx1ZUNvbXBhcmF0b3IsCiAgICAgICAgICAgICAgICBhcmdzOiB7CiAgICAgICAgICAgICAgICAgICAgbWF4UGVyY2VudGFnZURpZmZlcmVuY2U6IDEwLAogICAgICAgICAgICAgICAgICAgIG1heERpZmZlcmVuY2VzOiA1LAogICAgICAgICAgICAgICAgICAgIHBlbmFsdHlQb2ludHM6IDEwMAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmb250czogewogICAgICAgICAgICBpbnN0YWxsZWRGb250czogewogICAgICAgICAgICAgICAgcmVxdWlyZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgY29tcGFyYXRvcjogTXVsdGlWYWx1ZUNvbXBhcmF0b3IsCiAgICAgICAgICAgICAgICBhcmdzOiB7CiAgICAgICAgICAgICAgICAgICAgbWF4UGVyY2VudGFnZURpZmZlcmVuY2U6IDEwLAogICAgICAgICAgICAgICAgICAgIG1heERpZmZlcmVuY2VzOiA1LAogICAgICAgICAgICAgICAgICAgIHBlbmFsdHlQb2ludHM6IDEwMAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB0aW1lem9uZTogewogICAgICAgICAgICB0aW1lem9uZTogewogICAgICAgICAgICAgICAgcmVxdWlyZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgY29tcGFyYXRvcjogU2NhbGFyQ29tcGFyYXRvciwKICAgICAgICAgICAgICAgIGFyZ3M6IHsKICAgICAgICAgICAgICAgICAgICBwZW5hbHR5UG9pbnRzOiAxMDAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdXNlckFnZW50OiB7CiAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLAogICAgICAgICAgICBjb21wYXJhdG9yOiBVc2VyQWdlbnRDb21wYXJhdG9yLAogICAgICAgICAgICBhcmdzOiB7CiAgICAgICAgICAgICAgICBpZ25vcmVWZXJzaW9uOiB0cnVlLAogICAgICAgICAgICAgICAgcGVuYWx0eVBvaW50czogMTAwCiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGdlb2xvY2F0aW9uOiB7CiAgICAgICAgICAgIHJlcXVpcmVkOiBmYWxzZSwKICAgICAgICAgICAgY29tcGFyYXRvcjogR2VvbG9jYXRpb25Db21wYXJhdG9yLAogICAgICAgICAgICBhcmdzOiB7CiAgICAgICAgICAgICAgICBhbGxvd2VkUmFuZ2U6IDEwMCwJCQkvL2luIG1pbGVzCiAgICAgICAgICAgICAgICBwZW5hbHR5UG9pbnRzOiAxMDAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfTsKCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLy8KLy8gICAgICAgICAgICAgICAgICAgICAgICAgICBDb21wYXJhdG9yIGZ1bmN0aW9ucyAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS8vCgp2YXIgYWxsLCBhbnksIGNhbGN1bGF0ZURpc3RhbmNlLCBjYWxjdWxhdGVJbnRlcnNlY3Rpb24sIGNhbGN1bGF0ZVBlcmNlbnRhZ2UsIG51bGxPclVuZGVmaW5lZCwgc3BsaXRBbmRUcmltLAogICAgdW5kZWZpbmVkTG9jYXRpb247CgovLyBDb21wYXJpc29uUmVzdWx0CgovKioKICogQ29uc3RydWN0cyBhbiBpbnN0YW5jZSBvZiBhIENvbXBhcmlzb25SZXN1bHQgd2l0aCB0aGUgZ2l2ZW4gcGVuYWx0eSBwb2ludHMuCiAqCiAqIEBwYXJhbSBwZW5hbHR5UG9pbnRzIChOdW1iZXIpIFRoZSBwZW5hbHR5IHBvaW50cyBmb3IgdGhlIGNvbXBhcmlzb24gKGRlZmF1bHRzIHRvIDApLgogKiBAcGFyYW0gYWRkaXRpb25hbEluZm9JbkN1cnJlbnRWYWx1ZSAoYm9vbGVhbikgV2hldGhlciB0aGUgY3VycmVudCB2YWx1ZSBjb250YWlucyBtb3JlIGluZm9ybWF0aW9uCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGFuIHRoZSBzdG9yZWQgdmFsdWUgKGRlZmF1bHRzIHRvIGZhbHNlKS4KICovCmZ1bmN0aW9uIENvbXBhcmlzb25SZXN1bHQoKSB7CgogICAgdmFyIHBlbmFsdHlQb2ludHMgPSAwLAogICAgICAgIGFkZGl0aW9uYWxJbmZvSW5DdXJyZW50VmFsdWUgPSBmYWxzZTsKCiAgICBpZiAoYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBwZW5hbHR5UG9pbnRzID0gYXJndW1lbnRzWzBdOwogICAgICAgIGFkZGl0aW9uYWxJbmZvSW5DdXJyZW50VmFsdWUgPSBhcmd1bWVudHNbMV07CiAgICB9CgogICAgaWYgKGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkICYmIGFyZ3VtZW50c1sxXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKHR5cGVvZihhcmd1bWVudHNbMF0pID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgYWRkaXRpb25hbEluZm9JbkN1cnJlbnRWYWx1ZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwZW5hbHR5UG9pbnRzID0gYXJndW1lbnRzWzBdOwogICAgICAgIH0KICAgIH0KCiAgICB0aGlzLnBlbmFsdHlQb2ludHMgPSBwZW5hbHR5UG9pbnRzOwogICAgdGhpcy5hZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlID0gYWRkaXRpb25hbEluZm9JbkN1cnJlbnRWYWx1ZTsKCn0KCkNvbXBhcmlzb25SZXN1bHQuWkVST19QRU5BTFRZX1BPSU5UUyA9IG5ldyBDb21wYXJpc29uUmVzdWx0KDApOwoKLyoqCiAqIFN0YXRpYyBtZXRob2QgZm9yIGZ1bmN0aW9uYWwgcHJvZ3JhbW1pbmcuCiAqCiAqIEByZXR1cm4gYm9vbGVhbiB0cnVlIGlmIGNvbXBhcmlzb25SZXN1bHQuaXNTdWNjZXNzZnVsKCkuCiAqLwpDb21wYXJpc29uUmVzdWx0LmlzU3VjY2Vzc2Z1bCA9ICBmdW5jdGlvbihjb21wYXJpc29uUmVzdWx0KSB7CiAgICByZXR1cm4gY29tcGFyaXNvblJlc3VsdC5pc1N1Y2Nlc3NmdWwoKTsKfTsKCgovKioKICogU3RhdGljIG1ldGhvZCBmb3IgZnVuY3Rpb25hbCBwcm9ncmFtbWluZy4KICoKICogQHJldHVybiBib29sZWFuIHRydWUgaWYgY29tcGFyaXNvblJlc3VsdC5hZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlLgogKi8KQ29tcGFyaXNvblJlc3VsdC5hZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlID0gIGZ1bmN0aW9uKGNvbXBhcmlzb25SZXN1bHQpIHsKICAgIHJldHVybiBjb21wYXJpc29uUmVzdWx0LmFkZGl0aW9uYWxJbmZvSW5DdXJyZW50VmFsdWU7Cn07CgovKioKICogQ29tcGFyaXNvbiBmdW5jdGlvbiB0aGF0IGNhbiBiZSBwcm92aWRlZCBhcyBhbiBhcmd1bWVudCB0byBhcnJheS5zb3J0CiAqLwpDb21wYXJpc29uUmVzdWx0LmNvbXBhcmUgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kKSB7CiAgICBpZiAobnVsbE9yVW5kZWZpbmVkKGZpcnN0KSAmJiBudWxsT3JVbmRlZmluZWQoc2Vjb25kKSkgewogICAgICAgIHJldHVybiAwOwogICAgfSBlbHNlIGlmIChudWxsT3JVbmRlZmluZWQoZmlyc3QpKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfSBlbHNlIGlmIChudWxsT3JVbmRlZmluZWQoc2Vjb25kKSkgewogICAgICAgIHJldHVybiAxOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAoZmlyc3QucGVuYWx0eVBvaW50cyAhPT0gc2Vjb25kLnBlbmFsdHlQb2ludHMpIHsKICAgICAgICAgICAgcmV0dXJuIGZpcnN0LnBlbmFsdHlQb2ludHMgLSBzZWNvbmQucGVuYWx0eVBvaW50czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gKGZpcnN0LmFkZGl0aW9uYWxJbmZvSW5DdXJyZW50VmFsdWUgPyAxIDogMCkgLSAoc2Vjb25kLmFkZGl0aW9uYWxJbmZvSW5DdXJyZW50VmFsdWUgPyAxIDogMCk7CiAgICAgICAgfQogICAgfQp9OwoKLyoqCiAqIEFtYWxnYW1hdGVzIHRoZSBnaXZlbiBDb21wYXJpc29uUmVzdWx0IGludG8gdGhpcyBDb21wYXJpc29uUmVzdWx0LgogKgogKiBAcGFyYW0gY29tcGFyaXNvblJlc3VsdCBUaGUgQ29tcGFyaXNvblJlc3VsdCB0byBpbmNsdWRlLgogKi8KQ29tcGFyaXNvblJlc3VsdC5wcm90b3R5cGUuYWRkQ29tcGFyaXNvblJlc3VsdCA9IGZ1bmN0aW9uKGNvbXBhcmlzb25SZXN1bHQpIHsKICAgIHRoaXMucGVuYWx0eVBvaW50cyArPSBjb21wYXJpc29uUmVzdWx0LnBlbmFsdHlQb2ludHM7CiAgICBpZiAoY29tcGFyaXNvblJlc3VsdC5hZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlKSB7CiAgICAgICAgdGhpcy5hZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlID0gY29tcGFyaXNvblJlc3VsdC5hZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlOwogICAgfQp9OwoKLyoqCiAqIFJldHVybnMgdHJ1ZSBpZiBubyBwZW5hbHR5IHBvaW50cyBoYXZlIGJlZW4gYXNzaWduZWQgZm9yIHRoZSBjb21wYXJpc29uLgogKgogKiBAcmV0dXJuIGJvb2xlYW4gdHJ1ZSBpZiB0aGUgY29tcGFyaXNvbiB3YXMgc3VjY2Vzc2Z1bC4KICovCkNvbXBhcmlzb25SZXN1bHQucHJvdG90eXBlLmlzU3VjY2Vzc2Z1bCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG51bGxPclVuZGVmaW5lZCh0aGlzLnBlbmFsdHlQb2ludHMpIHx8IHRoaXMucGVuYWx0eVBvaW50cyA9PT0gMDsKfTsKCi8qKgogKiBDb21wYXJlcyB0d28gc2ltcGxlIG9iamVjdHMgKFN0cmluZ3xOdW1iZXIpIGFuZCBpZiB0aGV5IGFyZSBlcXVhbCB0aGVuIHJldHVybnMgYSBDb21wYXJpc29uUmVzdWx0IHdpdGggemVybwogKiBwZW5hbHR5IHBvaW50cyBhc3NpZ25lZCwgb3RoZXJ3aXNlIHJldHVybnMgYSBDb21wYXJpc29uUmVzdWx0IHdpdGggdGhlIGdpdmVuIG51bWJlciBvZiBwZW5hbHR5IHBvaW50cyBhc3NpZ25lZC4KICoKICogQHBhcmFtIGN1cnJlbnRWYWx1ZSAoU3RyaW5nfE51bWJlcikgVGhlIGN1cnJlbnQgdmFsdWUuCiAqIEBwYXJhbSBzdG9yZWRWYWx1ZSAoU3RyaW5nfE51bWJlcikgVGhlIHN0b3JlZCB2YWx1ZS4KICogQHBhcmFtIGNvbmZpZzogewogKiAgICAgICAgICAgICJwZW5hbHR5UG9pbnRzIjogKE51bWJlcikgVGhlIG51bWJlciBvZiBwZW5hbHR5IHBvaW50cy4KICogICAgICAgIH0KICogQHJldHVybiBDb21wYXJpc29uUmVzdWx0LgogKi8KU2NhbGFyQ29tcGFyYXRvci5jb21wYXJlID0gZnVuY3Rpb24gKGN1cnJlbnRWYWx1ZSwgc3RvcmVkVmFsdWUsIGNvbmZpZykgewogICAgaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIlN0cmluZ0NvbXBhcmF0b3IuY29tcGFyZTpjdXJyZW50VmFsdWU6ICIgKyBKU09OLnN0cmluZ2lmeShjdXJyZW50VmFsdWUpKTsKICAgICAgICBsb2dnZXIubWVzc2FnZSgiU3RyaW5nQ29tcGFyYXRvci5jb21wYXJlOnN0b3JlZFZhbHVlOiAiICsgSlNPTi5zdHJpbmdpZnkoc3RvcmVkVmFsdWUpKTsKICAgICAgICBsb2dnZXIubWVzc2FnZSgiU3RyaW5nQ29tcGFyYXRvci5jb21wYXJlOmNvbmZpZzogIiArIEpTT04uc3RyaW5naWZ5KGNvbmZpZykpOwogICAgfQogICAgaWYgKGNvbmZpZy5wZW5hbHR5UG9pbnRzID09PSAwKSB7CiAgICAgICAgcmV0dXJuIENvbXBhcmlzb25SZXN1bHQuWkVST19QRU5BTFRZX1BPSU5UUzsKICAgIH0KCiAgICBpZiAoIW51bGxPclVuZGVmaW5lZChzdG9yZWRWYWx1ZSkpIHsKICAgICAgICBpZiAobnVsbE9yVW5kZWZpbmVkKGN1cnJlbnRWYWx1ZSkgfHwgY3VycmVudFZhbHVlICE9PSBzdG9yZWRWYWx1ZSkgewogICAgICAgICAgICByZXR1cm4gbmV3IENvbXBhcmlzb25SZXN1bHQoY29uZmlnLnBlbmFsdHlQb2ludHMpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoIW51bGxPclVuZGVmaW5lZChjdXJyZW50VmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDb21wYXJpc29uUmVzdWx0KHRydWUpOwogICAgfQoKICAgIHJldHVybiBDb21wYXJpc29uUmVzdWx0LlpFUk9fUEVOQUxUWV9QT0lOVFM7Cn07CgovKioKICogQ29tcGFyZXMgdHdvIHNjcmVlbnMgYW5kIGlmIHRoZXkgYXJlIGVxdWFsIHRoZW4gcmV0dXJucyBhIENvbXBhcmlzb25SZXN1bHQgd2l0aCB6ZXJvIHBlbmFsdHkgcG9pbnRzIGFzc2lnbmVkLAogKiBvdGhlcndpc2UgcmV0dXJucyBhIENvbXBhcmlzb25SZXN1bHQgd2l0aCB0aGUgZ2l2ZW4gbnVtYmVyIG9mIHBlbmFsdHkgcG9pbnRzIGFzc2lnbmVkLgogKgogKiBAcGFyYW0gY3VycmVudFZhbHVlOiB7CiAqICAgICAgICAgICAgInNjcmVlbldpZHRoIjogKE51bWJlcikgVGhlIGN1cnJlbnQgY2xpZW50IHNjcmVlbiB3aWR0aC4KICogICAgICAgICAgICAic2NyZWVuSGVpZ2h0IjogKE51bWJlcikgVGhlIGN1cnJlbnQgY2xpZW50IHNjcmVlbiBoZWlnaHQuCiAqICAgICAgICAgICAgInNjcmVlbkNvbG91ckRlcHRoIjogKE51bWJlcikgVGhlIGN1cnJlbnQgY2xpZW50IHNjcmVlbiBjb2xvdXIgZGVwdGguCiAqICAgICAgICB9CiAqIEBwYXJhbSBzdG9yZWRWYWx1ZTogewogKiAgICAgICAgICAgICJzY3JlZW5XaWR0aCI6IChOdW1iZXIpIFRoZSBzdG9yZWQgY2xpZW50IHNjcmVlbiB3aWR0aC4KICogICAgICAgICAgICAic2NyZWVuSGVpZ2h0IjogKE51bWJlcikgVGhlIHN0b3JlZCBjbGllbnQgc2NyZWVuIGhlaWdodC4KICogICAgICAgICAgICAic2NyZWVuQ29sb3VyRGVwdGgiOiAoTnVtYmVyKSBUaGUgc3RvcmVkIGNsaWVudCBzY3JlZW4gY29sb3VyIGRlcHRoLgogKiAgICAgICAgfQogKiBAcGFyYW0gY29uZmlnOiB7CiAqICAgICAgICAgICAgInBlbmFsdHlQb2ludHMiOiAoTnVtYmVyKSBUaGUgbnVtYmVyIG9mIHBlbmFsdHkgcG9pbnRzLgogKiAgICAgICAgfQogKiBAcmV0dXJuIENvbXBhcmlzb25SZXN1bHQKICovClNjcmVlbkNvbXBhcmF0b3IuY29tcGFyZSA9IGZ1bmN0aW9uIChjdXJyZW50VmFsdWUsIHN0b3JlZFZhbHVlLCBjb25maWcpIHsKICAgIGlmIChsb2dnZXIubWVzc2FnZUVuYWJsZWQoKSkgewogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJTY3JlZW5Db21wYXJhdG9yLmNvbXBhcmU6Y3VycmVudFZhbHVlOiAiICsgSlNPTi5zdHJpbmdpZnkoY3VycmVudFZhbHVlKSk7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIlNjcmVlbkNvbXBhcmF0b3IuY29tcGFyZTpzdG9yZWRWYWx1ZTogIiArIEpTT04uc3RyaW5naWZ5KHN0b3JlZFZhbHVlKSk7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIlNjcmVlbkNvbXBhcmF0b3IuY29tcGFyZTpjb25maWc6ICIgKyBKU09OLnN0cmluZ2lmeShjb25maWcpKTsKICAgIH0KCiAgICBpZiAobnVsbE9yVW5kZWZpbmVkKGN1cnJlbnRWYWx1ZSkpIHsKICAgICAgICBjdXJyZW50VmFsdWUgPSB7c2NyZWVuV2lkdGg6IG51bGwsIHNjcmVlbkhlaWdodDogbnVsbCwgc2NyZWVuQ29sb3VyRGVwdGg6IG51bGx9OwogICAgfQogICAgaWYgKG51bGxPclVuZGVmaW5lZChzdG9yZWRWYWx1ZSkpIHsKICAgICAgICBzdG9yZWRWYWx1ZSA9IHtzY3JlZW5XaWR0aDogbnVsbCwgc2NyZWVuSGVpZ2h0OiBudWxsLCBzY3JlZW5Db2xvdXJEZXB0aDogbnVsbH07CiAgICB9CgogICAgdmFyIGNvbXBhcmlzb25SZXN1bHRzID0gWwogICAgICAgIFNjYWxhckNvbXBhcmF0b3IuY29tcGFyZShjdXJyZW50VmFsdWUuc2NyZWVuV2lkdGgsIHN0b3JlZFZhbHVlLnNjcmVlbldpZHRoLCBjb25maWcpLAogICAgICAgIFNjYWxhckNvbXBhcmF0b3IuY29tcGFyZShjdXJyZW50VmFsdWUuc2NyZWVuSGVpZ2h0LCBzdG9yZWRWYWx1ZS5zY3JlZW5IZWlnaHQsIGNvbmZpZyksCiAgICAgICAgU2NhbGFyQ29tcGFyYXRvci5jb21wYXJlKGN1cnJlbnRWYWx1ZS5zY3JlZW5Db2xvdXJEZXB0aCwgc3RvcmVkVmFsdWUuc2NyZWVuQ29sb3VyRGVwdGgsIGNvbmZpZyldOwoKICAgIGlmIChhbGwoY29tcGFyaXNvblJlc3VsdHMsIENvbXBhcmlzb25SZXN1bHQuaXNTdWNjZXNzZnVsKSkgewogICAgICAgIHJldHVybiBuZXcgQ29tcGFyaXNvblJlc3VsdChhbnkoY29tcGFyaXNvblJlc3VsdHMsIENvbXBhcmlzb25SZXN1bHQuYWRkaXRpb25hbEluZm9JbkN1cnJlbnRWYWx1ZSkpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IENvbXBhcmlzb25SZXN1bHQoY29uZmlnLnBlbmFsdHlQb2ludHMpOwogICAgfQp9OwoKLyoqCiAqIFNwbGl0cyBib3RoIHZhbHVlcyB1c2luZyBkZWxpbWl0ZXIsIHRyaW1zIGV2ZXJ5IHZhbHVlIGFuZCBjb21wYXJlcyBjb2xsZWN0aW9ucyBvZiB2YWx1ZXMuCiAqIFJldHVybnMgemVyby1yZXN1bHQgZm9yIHNhbWUgbXVsdGktdmFsdWUgYXR0cmlidXRlcy4KICoKICogSWYgY29sbGVjdGlvbnMgYXJlIG5vdCBzYW1lIGNoZWNrcyBpZiBudW1iZXIgb2YgZGlmZmVyZW5jZXMgaXMgbGVzcyBvciBlcXVhbCBtYXhEaWZmZXJlbmNlcyBvcgogKiBwZXJjZW50YWdlIG9mIGRpZmZlcmVuY2UgaXMgbGVzcyBvciBlcXVhbCBtYXhQZXJjZW50YWdlRGlmZmVyZW5jZS4KICoKICogSWYgeWVzIHRoZW4gcmV0dXJucyB6ZXJvLXJlc3VsdCB3aXRoIGFkZGl0aW9uYWwgaW5mbywgZWxzZSByZXR1cm5zIHBlbmFsdHlQb2ludHMtcmVzdWx0LgogKgogKiBAcGFyYW0gY3VycmVudFZhbHVlOiAoU3RyaW5nKSBUaGUgY3VycmVudCB2YWx1ZS4KICogQHBhcmFtIHN0b3JlZFZhbHVlOiAoU3RyaW5nKSBUaGUgc3RvcmVkIHZhbHVlLgogKiBAcGFyYW0gY29uZmlnOiB7CiAqICAgICAgICAgICAgIm1heFBlcmNlbnRhZ2VEaWZmZXJlbmNlIjogKE51bWJlcikgVGhlIG1heCBkaWZmZXJlbmNlIHBlcmNlbnRhZ2UgaW4gdGhlIHZhbHVlcywKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmUgdGhlIHBlbmFsdHkgaXMgYXNzaWduZWQuCiAqICAgICAgICAgICAgIm1heERpZmZlcmVuY2VzIjogKE51bWJlcikgVGhlIG1heCBudW1iZXIgb2YgZGlmZmVyZW5jZXMgaW4gdGhlIHZhbHVlcywKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmUgdGhlIHBlbmFsdHkgcG9pbnRzIGFyZSBhc3NpZ25lZC4KICogICAgICAgICAgICAicGVuYWx0eVBvaW50cyI6IChOdW1iZXIpIFRoZSBudW1iZXIgb2YgcGVuYWx0eSBwb2ludHMuCiAgKiAgICAgICAgfQogKiBAcmV0dXJuIENvbXBhcmlzb25SZXN1bHQKICovCk11bHRpVmFsdWVDb21wYXJhdG9yLmNvbXBhcmUgPSBmdW5jdGlvbiAoY3VycmVudFZhbHVlLCBzdG9yZWRWYWx1ZSwgY29uZmlnKSB7CiAgICBpZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgICAgICBsb2dnZXIubWVzc2FnZSgiTXVsdGlWYWx1ZUNvbXBhcmF0b3IuY29tcGFyZTpjdXJyZW50VmFsdWU6ICIgKyBKU09OLnN0cmluZ2lmeShjdXJyZW50VmFsdWUpKTsKICAgICAgICBsb2dnZXIubWVzc2FnZSgiTXVsdGlWYWx1ZUNvbXBhcmF0b3IuY29tcGFyZTpzdG9yZWRWYWx1ZTogIiArIEpTT04uc3RyaW5naWZ5KHN0b3JlZFZhbHVlKSk7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIk11bHRpVmFsdWVDb21wYXJhdG9yLmNvbXBhcmU6Y29uZmlnOiAiICsgSlNPTi5zdHJpbmdpZnkoY29uZmlnKSk7CiAgICB9CgogICAgdmFyIGRlbGltaXRlciA9ICI7IiwKICAgICAgICBjdXJyZW50VmFsdWVzID0gc3BsaXRBbmRUcmltKGN1cnJlbnRWYWx1ZSwgZGVsaW1pdGVyKSwKICAgICAgICBzdG9yZWRWYWx1ZXMgPSBzcGxpdEFuZFRyaW0oc3RvcmVkVmFsdWUsIGRlbGltaXRlciksCiAgICAgICAgbWF4TnVtYmVyT2ZFbGVtZW50cyA9IE1hdGgubWF4KGN1cnJlbnRWYWx1ZXMubGVuZ3RoLCBzdG9yZWRWYWx1ZXMubGVuZ3RoKSwKICAgICAgICBudW1iZXJPZlRoZVNhbWVFbGVtZW50cyA9IGNhbGN1bGF0ZUludGVyc2VjdGlvbihjdXJyZW50VmFsdWVzLCBzdG9yZWRWYWx1ZXMpLmxlbmd0aCwKICAgICAgICBudW1iZXJPZkRpZmZlcmVuY2VzID0gbWF4TnVtYmVyT2ZFbGVtZW50cyAtIG51bWJlck9mVGhlU2FtZUVsZW1lbnRzLAogICAgICAgIHBlcmNlbnRhZ2VPZkRpZmZlcmVuY2VzID0gY2FsY3VsYXRlUGVyY2VudGFnZShudW1iZXJPZkRpZmZlcmVuY2VzLCBtYXhOdW1iZXJPZkVsZW1lbnRzKTsKCiAgICBpZiAobnVsbE9yVW5kZWZpbmVkKHN0b3JlZFZhbHVlKSAmJiAhbnVsbE9yVW5kZWZpbmVkKGN1cnJlbnRWYWx1ZSkpIHsKICAgICAgICByZXR1cm4gbmV3IENvbXBhcmlzb25SZXN1bHQodHJ1ZSk7CiAgICB9CgogICAgaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UobnVtYmVyT2ZUaGVTYW1lRWxlbWVudHMgKyAiIG9mICIgKyBtYXhOdW1iZXJPZkVsZW1lbnRzICsgIiBhcmUgc2FtZSIpOwogICAgfQoKICAgIGlmIChtYXhOdW1iZXJPZkVsZW1lbnRzID09PSAwKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIklnbm9yZWQgYmVjYXVzZSBubyBhdHRyaWJ1dGVzIGZvdW5kIGluIGJvdGggcHJvZmlsZXMiKTsKICAgICAgICByZXR1cm4gQ29tcGFyaXNvblJlc3VsdC5aRVJPX1BFTkFMVFlfUE9JTlRTOwogICAgfQoKICAgIGlmIChudW1iZXJPZlRoZVNhbWVFbGVtZW50cyA9PT0gbWF4TnVtYmVyT2ZFbGVtZW50cykgewogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJJZ25vcmVkIGJlY2F1c2UgYWxsIGF0dHJpYnV0ZXMgYXJlIHNhbWUiKTsKICAgICAgICByZXR1cm4gQ29tcGFyaXNvblJlc3VsdC5aRVJPX1BFTkFMVFlfUE9JTlRTOwogICAgfQoKICAgIGlmIChudW1iZXJPZkRpZmZlcmVuY2VzID4gY29uZmlnLm1heERpZmZlcmVuY2VzKSB7CiAgICAgICAgaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGxvZ2dlci5tZXNzYWdlKCJXb3VsZCBiZSBpZ25vcmVkIGlmIG5vdCBtb3JlIHRoYW4gIiArIGNvbmZpZy5tYXhEaWZmZXJlbmNlcyArICIgZGlmZmVyZW5jZXMiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBDb21wYXJpc29uUmVzdWx0KGNvbmZpZy5wZW5hbHR5UG9pbnRzKTsKICAgIH0KCiAgICBpZiAocGVyY2VudGFnZU9mRGlmZmVyZW5jZXMgPiBjb25maWcubWF4UGVyY2VudGFnZURpZmZlcmVuY2UpIHsKICAgICAgICBpZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgICAgICAgICAgbG9nZ2VyLm1lc3NhZ2UocGVyY2VudGFnZU9mRGlmZmVyZW5jZXMgKyAiIHBlcmNlbnRzIGFyZSBkaWZmZXJlbnQiKTsKICAgICAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIldvdWxkIGJlIGlnbm9yZWQgaWYgbm90IG1vcmUgdGhhbiAiICsgY29uZmlnLm1heFBlcmNlbnRhZ2VEaWZmZXJlbmNlICsgIiBwZXJjZW50Iik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgQ29tcGFyaXNvblJlc3VsdChjb25maWcucGVuYWx0eVBvaW50cyk7CiAgICB9CgogICAgaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIklnbm9yZWQgYmVjYXVzZSBudW1iZXIgb2YgZGlmZmVyZW5jZXMoIiArIG51bWJlck9mRGlmZmVyZW5jZXMgKyAiKSBub3QgbW9yZSB0aGFuICIKICAgICAgICAgICAgKyBjb25maWcubWF4RGlmZmVyZW5jZXMpOwogICAgICAgIGxvZ2dlci5tZXNzYWdlKHBlcmNlbnRhZ2VPZkRpZmZlcmVuY2VzICsgIiBwZXJjZW50cyBhcmUgZGlmZmVyZW50Iik7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIklnbm9yZWQgYmVjYXVzZSBub3QgbW9yZSB0aGFuICIgKyBjb25maWcubWF4UGVyY2VudGFnZURpZmZlcmVuY2UgKyAiIHBlcmNlbnQiKTsKICAgIH0KICAgIHJldHVybiBuZXcgQ29tcGFyaXNvblJlc3VsdCh0cnVlKTsKfTsKCi8qKgogKiBDb21wYXJlcyB0d28gVXNlciBBZ2VudCBTdHJpbmdzIGFuZCBpZiB0aGV5IGFyZSBlcXVhbCB0aGVuIHJldHVybnMgYSBDb21wYXJpc29uUmVzdWx0IHdpdGggemVybyBwZW5hbHR5CiAqIHBvaW50cyBhc3NpZ25lZCwgb3RoZXJ3aXNlIHJldHVybnMgYSBDb21wYXJpc29uUmVzdWx0IHdpdGggdGhlIGdpdmVuIG51bWJlciBvZiBwZW5hbHR5IHBvaW50cyBhc3NpZ25lZC4KICoKICogQHBhcmFtIGN1cnJlbnRWYWx1ZSAoU3RyaW5nKSBUaGUgY3VycmVudCB2YWx1ZS4KICogQHBhcmFtIHN0b3JlZFZhbHVlIChTdHJpbmcpIFRoZSBzdG9yZWQgdmFsdWUuCiAqIEBwYXJhbSBjb25maWc6IHsKICogICAgICAgICAgICAiaWdub3JlVmVyc2lvbiI6IChib29sZWFuKSBJZiB0aGUgdmVyc2lvbiBudW1iZXJzIGluIHRoZSBVc2VyIEFnZW50IFN0cmluZ3Mgc2hvdWxkIGJlIGlnbm9yZQogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluIHRoZSBjb21wYXJpc29uLgogKiAgICAgICAgICAgICJwZW5hbHR5UG9pbnRzIjogKE51bWJlcikgVGhlIG51bWJlciBvZiBwZW5hbHR5IHBvaW50cy4KICogICAgICAgIH0KICogQHJldHVybiBBIENvbXBhcmlzb25SZXN1bHQuCiAqLwpVc2VyQWdlbnRDb21wYXJhdG9yLmNvbXBhcmUgPSBmdW5jdGlvbiAoY3VycmVudFZhbHVlLCBzdG9yZWRWYWx1ZSwgY29uZmlnKSB7CiAgICBpZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgICAgICBsb2dnZXIubWVzc2FnZSgiVXNlckFnZW50Q29tcGFyYXRvci5jb21wYXJlOmN1cnJlbnRWYWx1ZTogIiArIEpTT04uc3RyaW5naWZ5KGN1cnJlbnRWYWx1ZSkpOwogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJVc2VyQWdlbnRDb21wYXJhdG9yLmNvbXBhcmU6c3RvcmVkVmFsdWU6ICIgKyBKU09OLnN0cmluZ2lmeShzdG9yZWRWYWx1ZSkpOwogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJVc2VyQWdlbnRDb21wYXJhdG9yLmNvbXBhcmU6Y29uZmlnOiAiICsgSlNPTi5zdHJpbmdpZnkoY29uZmlnKSk7CiAgICB9CgogICAgaWYgKGNvbmZpZy5pZ25vcmVWZXJzaW9uKSB7CiAgICAgICAgLy8gcmVtb3ZlIHZlcnNpb24gbnVtYmVyCiAgICAgICAgY3VycmVudFZhbHVlID0gbnVsbE9yVW5kZWZpbmVkKGN1cnJlbnRWYWx1ZSkgPyBudWxsIDogY3VycmVudFZhbHVlLnJlcGxhY2UoL1tcZFwuXSsvZywgIiIpLnRyaW0oKTsKICAgICAgICBzdG9yZWRWYWx1ZSA9IG51bGxPclVuZGVmaW5lZChzdG9yZWRWYWx1ZSkgPyBudWxsIDogc3RvcmVkVmFsdWUucmVwbGFjZSgvW1xkXC5dKy9nLCAiIikudHJpbSgpOwogICAgfQoKICAgIHJldHVybiBTY2FsYXJDb21wYXJhdG9yLmNvbXBhcmUoY3VycmVudFZhbHVlLCBzdG9yZWRWYWx1ZSwgY29uZmlnKTsKfTsKCi8qKgogKiBDb21wYXJlcyB0d28gbG9jYXRpb25zLCB0YWtpbmcgaW50byBhY2NvdW50IGEgZGVncmVlIG9mIGRpZmZlcmVuY2UuCiAqCiAqIEBwYXJhbSBjdXJyZW50VmFsdWU6IHsKICogICAgICAgICAgICAibGF0aXR1ZGUiOiAoTnVtYmVyKSBUaGUgY3VycmVudCBsYXRpdHVkZS4KICogICAgICAgICAgICAibG9uZ2l0dWRlIjogKE51bWJlcikgVGhlIGN1cnJlbnQgbG9uZ2l0dWRlLgogKiAgICAgICAgfQogKiBAcGFyYW0gc3RvcmVkVmFsdWU6IHsKICogICAgICAgICAgICAibGF0aXR1ZGUiOiAoTnVtYmVyKSBUaGUgc3RvcmVkIGxhdGl0dWRlLgogKiAgICAgICAgICAgICJsb25naXR1ZGUiOiAoTnVtYmVyKSBUaGUgc3RvcmVkIGxvbmdpdHVkZS4KICogICAgICAgIH0KICogQHBhcmFtIGNvbmZpZzogewogKiAgICAgICAgICAgICJhbGxvd2VkUmFuZ2UiOiAoTnVtYmVyKSBUaGUgbWF4IGRpZmZlcmVuY2UgYWxsb3dlZCBpbiB0aGUgdHdvIGxvY2F0aW9ucywgYmVmb3JlIHRoZSBwZW5hbHR5IGlzIGFzc2lnbmVkLgogKiAgICAgICAgICAgICJwZW5hbHR5UG9pbnRzIjogKE51bWJlcikgVGhlIG51bWJlciBvZiBwZW5hbHR5IHBvaW50cy4KKiAgICAgICAgIH0KICogQHJldHVybiBDb21wYXJpc29uUmVzdWx0CiAqLwpHZW9sb2NhdGlvbkNvbXBhcmF0b3IuY29tcGFyZSA9IGZ1bmN0aW9uIChjdXJyZW50VmFsdWUsIHN0b3JlZFZhbHVlLCBjb25maWcpIHsKICAgIGlmIChsb2dnZXIubWVzc2FnZUVuYWJsZWQoKSkgewogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJHZW9sb2NhdGlvbkNvbXBhcmF0b3IuY29tcGFyZTpjdXJyZW50VmFsdWU6ICIgKyBKU09OLnN0cmluZ2lmeShjdXJyZW50VmFsdWUpKTsKICAgICAgICBsb2dnZXIubWVzc2FnZSgiR2VvbG9jYXRpb25Db21wYXJhdG9yLmNvbXBhcmU6c3RvcmVkVmFsdWU6ICIgKyBKU09OLnN0cmluZ2lmeShzdG9yZWRWYWx1ZSkpOwogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJHZW9sb2NhdGlvbkNvbXBhcmF0b3IuY29tcGFyZTpjb25maWc6ICIgKyBKU09OLnN0cmluZ2lmeShjb25maWcpKTsKICAgIH0KCiAgICAvLyBDaGVjayBmb3IgdW5kZWZpbmVkIHN0b3JlZCBvciBjdXJyZW50IGxvY2F0aW9ucwoKICAgIGlmICh1bmRlZmluZWRMb2NhdGlvbihjdXJyZW50VmFsdWUpICYmIHVuZGVmaW5lZExvY2F0aW9uKHN0b3JlZFZhbHVlKSkgewogICAgICAgIHJldHVybiBDb21wYXJpc29uUmVzdWx0LlpFUk9fUEVOQUxUWV9QT0lOVFM7CiAgICB9CiAgICBpZiAodW5kZWZpbmVkTG9jYXRpb24oY3VycmVudFZhbHVlKSAmJiAhdW5kZWZpbmVkTG9jYXRpb24oc3RvcmVkVmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDb21wYXJpc29uUmVzdWx0KGNvbmZpZy5wZW5hbHR5UG9pbnRzKTsKICAgIH0KICAgIGlmICghdW5kZWZpbmVkTG9jYXRpb24oY3VycmVudFZhbHVlKSAmJiB1bmRlZmluZWRMb2NhdGlvbihzdG9yZWRWYWx1ZSkpIHsKICAgICAgICByZXR1cm4gbmV3IENvbXBhcmlzb25SZXN1bHQodHJ1ZSk7CiAgICB9CgogICAgLy8gQm90aCBsb2NhdGlvbnMgZGVmaW5lZCwgdGhlcmVmb3JlIHBlcmZvcm0gY29tcGFyaXNvbgoKICAgIHZhciBkaXN0YW5jZSA9IGNhbGN1bGF0ZURpc3RhbmNlKGN1cnJlbnRWYWx1ZSwgc3RvcmVkVmFsdWUpOwoKICAgIGlmIChsb2dnZXIubWVzc2FnZUVuYWJsZWQoKSkgewogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJEaXN0YW5jZSBiZXR3ZWVuICgiICsgY3VycmVudFZhbHVlLmxhdGl0dWRlICsgIiwiICsgY3VycmVudFZhbHVlLmxvbmdpdHVkZSArICIpIGFuZCAoIiArCiAgICAgICAgICAgIHN0b3JlZFZhbHVlLmxhdGl0dWRlICsgIiwiICsgc3RvcmVkVmFsdWUubG9uZ2l0dWRlICsgIikgaXMgIiArIGRpc3RhbmNlICsgIiBtaWxlcyIpOwogICAgfQoKICAgIGlmIChwYXJzZUZsb2F0KGRpc3RhbmNlLnRvUHJlY2lzaW9uKDUpKSA9PT0gMCkgewogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJMb2NhdGlvbiBpcyB0aGUgc2FtZSIpOwogICAgICAgIHJldHVybiBDb21wYXJpc29uUmVzdWx0LlpFUk9fUEVOQUxUWV9QT0lOVFM7CiAgICB9CgogICAgaWYgKGRpc3RhbmNlIDw9IGNvbmZpZy5hbGxvd2VkUmFuZ2UpIHsKICAgICAgICBpZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgICAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIlRvbGVyYXRlZCBiZWNhdXNlIGRpc3RhbmNlIG5vdCBtb3JlIHRoZW4gIiArIGNvbmZpZy5hbGxvd2VkUmFuZ2UpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IENvbXBhcmlzb25SZXN1bHQodHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICAgIGlmIChsb2dnZXIubWVzc2FnZUVuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIubWVzc2FnZSgiV291bGQgYmUgaWdub3JlZCBpZiBkaXN0YW5jZSBub3QgbW9yZSB0aGVuICIgKyBjb25maWcuYWxsb3dlZFJhbmdlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBDb21wYXJpc29uUmVzdWx0KGNvbmZpZy5wZW5hbHR5UG9pbnRzKTsKICAgIH0KfTsKCgovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS8vCi8vICAgICAgICAgICAgICAgICAgICBEZXZpY2UgUHJpbnQgTG9naWMgLSBETyBOT1QgTU9ESUZZICAgICAgICAgICAgICAgICAgICAgLy8KLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0vLwoKLy8gVXRpbGl0eSBmdW5jdGlvbnMKCi8qKgogKiBSZXR1cm5zIHRydWUgaWYgZXZhbHVhdGluZyBmdW5jdGlvbiBmIG9uIGVhY2ggZWxlbWVudCBvZiB0aGUgQXJyYXkgYSByZXR1cm5zIHRydWUuCiAqCiAqIEBwYXJhbSBhOiAoQXJyYXkpIFRoZSBhcnJheSBvZiBlbGVtZW50cyB0byBldmFsdWF0ZQogKiBAcGFyYW0gZjogKEZ1bmN0aW9uKSBBIHNpbmdsZSBhcmd1bWVudCBmdW5jdGlvbiBmb3IgbWFwcGluZyBlbGVtZW50cyBvZiB0aGUgYXJyYXkgdG8gYm9vbGVhbi4KICogQHJldHVybiBib29sZWFuLgogKi8KYWxsID0gZnVuY3Rpb24oYSwgZikgewogICAgdmFyIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChmKGFbaV0pID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7Cn07CgovKioKICogUmV0dXJucyB0cnVlIGlmIGV2YWx1YXRpbmcgZnVuY3Rpb24gZiBvbiBhbnkgZWxlbWVudCBvZiB0aGUgQXJyYXkgYSByZXR1cm5zIHRydWUuCiAqCiAqIEBwYXJhbSBhOiAoQXJyYXkpIFRoZSBhcnJheSBvZiBlbGVtZW50cyB0byBldmFsdWF0ZQogKiBAcGFyYW0gZjogKEZ1bmN0aW9uKSBBIHNpbmdsZSBhcmd1bWVudCBmdW5jdGlvbiBmb3IgbWFwcGluZyBlbGVtZW50cyBvZiB0aGUgYXJyYXkgdG8gYm9vbGVhbi4KICogQHJldHVybiBib29sZWFuLgogKi8KYW55ID0gZnVuY3Rpb24oYSwgZikgewogICAgdmFyIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChmKGFbaV0pID09PSB0cnVlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKfTsKCi8qKgogKiBSZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIGxvY2F0aW9uIGlzIG51bGwgb3IgaGFzIHVuZGVmaW5lZCBsb25naXR1ZGUgb3IgbGF0aXR1ZGUgdmFsdWVzLgogKgogKiBAcGFyYW0gbG9jYXRpb246IHsKICogICAgICAgICAgICAibGF0aXR1ZGUiOiAoTnVtYmVyKSBUaGUgbGF0aXR1ZGUuCiAqICAgICAgICAgICAgImxvbmdpdHVkZSI6IChOdW1iZXIpIFRoZSBsb25naXR1ZGUuCiAqICAgICAgICB9CiAqIEByZXR1cm4gYm9vbGVhbgogKi8KdW5kZWZpbmVkTG9jYXRpb24gPSBmdW5jdGlvbihsb2NhdGlvbikgewogICAgcmV0dXJuIG51bGxPclVuZGVmaW5lZChsb2NhdGlvbikgfHwgbnVsbE9yVW5kZWZpbmVkKGxvY2F0aW9uLmxhdGl0dWRlKSB8fCBudWxsT3JVbmRlZmluZWQobG9jYXRpb24ubG9uZ2l0dWRlKTsKfTsKCi8qKgogKiBSZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIHZhbHVlIGlzIG51bGwgb3IgdW5kZWZpbmVkLgogKgogKiBAcGFyYW0gdmFsdWU6IGEgdmFsdWUgb2YgYW55IHR5cGUKICogQHJldHVybiBib29sZWFuCiAqLwpudWxsT3JVbmRlZmluZWQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQ7Cn07CgovKioKICogQ2FsY3VsYXRlcyB0aGUgZGlzdGFuY2VzIGJldHdlZW4gdGhlIHR3byBsb2NhdGlvbnMuCiAqCiAqIEBwYXJhbSBmaXJzdDogewogKiAgICAgICAgICAgICJsYXRpdHVkZSI6IChOdW1iZXIpIFRoZSBmaXJzdCBsYXRpdHVkZS4KICogICAgICAgICAgICAibG9uZ2l0dWRlIjogKE51bWJlcikgVGhlIGZpcnN0IGxvbmdpdHVkZS4KICogICAgICAgIH0KICogQHBhcmFtIHNlY29uZDogewogKiAgICAgICAgICAgICJsYXRpdHVkZSI6IChOdW1iZXIpIFRoZSBzZWNvbmQgbGF0aXR1ZGUuCiAqICAgICAgICAgICAgImxvbmdpdHVkZSI6IChOdW1iZXIpIFRoZSBzZWNvbmQgbG9uZ2l0dWRlLgogKiAgICAgICAgfQogKiBAcmV0dXJuIE51bWJlciBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdHdvIGxvY2F0aW9ucy4KICovCmNhbGN1bGF0ZURpc3RhbmNlID0gZnVuY3Rpb24oZmlyc3QsIHNlY29uZCkgewogICAgdmFyIGZhY3RvciA9IChNYXRoLlBJIC8gMTgwKSwKICAgICAgICB0aGV0YSwKICAgICAgICBkaXN0OwogICAgZnVuY3Rpb24gZGVncmVlc1RvUmFkaWFucyhkZWdyZWVzKSB7CiAgICAgICAgcmV0dXJuIGRlZ3JlZXMgKiBmYWN0b3I7CiAgICB9CiAgICBmdW5jdGlvbiByYWRpYW5zVG9EZWdyZWVzKHJhZGlhbnMpIHsKICAgICAgICByZXR1cm4gcmFkaWFucyAvIGZhY3RvcjsKICAgIH0KICAgIHRoZXRhID0gZmlyc3QubG9uZ2l0dWRlIC0gc2Vjb25kLmxvbmdpdHVkZTsKICAgIGRpc3QgPSBNYXRoLnNpbihkZWdyZWVzVG9SYWRpYW5zKGZpcnN0LmxhdGl0dWRlKSkgKiBNYXRoLnNpbihkZWdyZWVzVG9SYWRpYW5zKHNlY29uZC5sYXRpdHVkZSkpCiAgICAgICAgKyBNYXRoLmNvcyhkZWdyZWVzVG9SYWRpYW5zKGZpcnN0LmxhdGl0dWRlKSkgKiBNYXRoLmNvcyhkZWdyZWVzVG9SYWRpYW5zKHNlY29uZC5sYXRpdHVkZSkpCiAgICAgICAgKiBNYXRoLmNvcyhkZWdyZWVzVG9SYWRpYW5zKHRoZXRhKSk7CiAgICBkaXN0ID0gTWF0aC5hY29zKGRpc3QpOwogICAgZGlzdCA9IHJhZGlhbnNUb0RlZ3JlZXMoZGlzdCk7CiAgICBkaXN0ID0gZGlzdCAqIDYwICogMS4xNTE1OwogICAgcmV0dXJuIGRpc3Q7Cn07CgovKioKICogQ29udmVydHMgYSBTdHJpbmcgaG9sZGluZyBhIGRlbGltaXRlZCBzZXF1ZW5jZSBvZiB2YWx1ZXMgaW50byBhbiBhcnJheS4KICoKICogQHBhcmFtIHRleHQgKFN0cmluZykgVGhlIFN0cmluZyByZXByZXNlbnRhdGlvbiBvZiBhIGRlbGltaXRlZCBzZXF1ZW5jZSBvZiB2YWx1ZXMuCiAqIEBwYXJhbSBkZWxpbWl0ZXIgKFN0cmluZykgVGhlIGNoYXJhY3RlciBkZWxpbWl0aW5nIHZhbHVlcyB3aXRoaW4gdGhlIHRleHQgU3RyaW5nLgogKiBAcmV0dXJuIChBcnJheSkgVGhlIGNvbW1hIHNlcGFyYXRlZCB2YWx1ZXMuCiAqLwpzcGxpdEFuZFRyaW0gPSBmdW5jdGlvbih0ZXh0LCBkZWxpbWl0ZXIpIHsKCiAgICB2YXIgcmVzdWx0cyA9IFtdLAogICAgICAgIGksCiAgICAgICAgdmFsdWVzLAogICAgICAgIHZhbHVlOwogICAgaWYgKHRleHQgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgIH0KCiAgICB2YWx1ZXMgPSB0ZXh0LnNwbGl0KGRlbGltaXRlcik7CiAgICBmb3IgKGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFsdWUgPSB2YWx1ZXNbaV0udHJpbSgpOwogICAgICAgIGlmICh2YWx1ZSAhPT0gIiIpIHsKICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdHM7Cn07CgovKioKICogQ29udmVydHMgdmFsdWUgdG8gYSBwZXJjZW50YWdlIG9mIHJhbmdlLgogKgogKiBAcGFyYW0gdmFsdWUgKE51bWJlcikgVGhlIGFjdHVhbCBudW1iZXIgdG8gYmUgY29udmVydGVkIHRvIGEgcGVyY2VudGFnZS4KICogQHBhcmFtIHJhbmdlIChOdW1iZXIpIFRoZSB0b3RhbCBudW1iZXIgb2YgdmFsdWVzIChpLmUuIHJlcHJlc2VudHMgMTAwJSkuCiAqIEByZXR1cm4gKE51bWJlcikgVGhlIHBlcmNlbnRhZ2UuCiAqLwpjYWxjdWxhdGVQZXJjZW50YWdlID0gZnVuY3Rpb24odmFsdWUsIHJhbmdlKSB7CiAgICBpZiAocmFuZ2UgPT09IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIHJldHVybiBwYXJzZUZsb2F0KCh2YWx1ZSAvIHJhbmdlKS50b1ByZWNpc2lvbigyKSkgKiAxMDA7Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBhcnJheSBjb250YWluaW5nIG9ubHkgdGhvc2UgZWxlbWVudHMgZm91bmQgaW4gYm90aCBhcnJheXMgcmVjZWl2ZWQgYXMgYXJndW1lbnRzLgogKgogKiBAcGFyYW0gZmlyc3QgKEFycmF5KSBUaGUgZmlyc3QgYXJyYXkuCiAqIEBwYXJhbSBzZWNvbmQgKEFycmF5KSBUaGUgc2Vjb25kIGFycmF5LgogKiBAcmV0dXJuIChBcnJheSkgVGhlIGVsZW1lbnRzIHRoYXQgZm91bmQgaW4gZmlyc3QgYW5kIHNlY29uZC4KICovCmNhbGN1bGF0ZUludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQpIHsKICAgIHJldHVybiBmaXJzdC5maWx0ZXIoZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHJldHVybiBzZWNvbmQuaW5kZXhPZihlbGVtZW50KSAhPT0gLTE7CiAgICB9KTsKfTsKCmZ1bmN0aW9uIGdldFZhbHVlKG9iaiwgYXR0cmlidXRlUGF0aCkgewogICAgdmFyIHZhbHVlID0gb2JqLAogICAgICAgIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgYXR0cmlidXRlUGF0aC5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YWx1ZSA9IHZhbHVlW2F0dHJpYnV0ZVBhdGhbaV1dOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwp9CgoKZnVuY3Rpb24gaXNMZWFmTm9kZShhdHRyaWJ1dGVDb25maWcpIHsKICAgIHJldHVybiBhdHRyaWJ1dGVDb25maWcuY29tcGFyYXRvciAhPT0gdW5kZWZpbmVkOwp9CgpmdW5jdGlvbiBnZXRBdHRyaWJ1dGVQYXRocyhhdHRyaWJ1dGVDb25maWcsIGF0dHJpYnV0ZVBhdGgpIHsKCiAgICB2YXIgYXR0cmlidXRlUGF0aHMgPSBbXSwKICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgIGF0dHJQYXRocywKICAgICAgICBhdHRyUGF0aCwKICAgICAgICBpOwoKICAgIGZvciAoYXR0cmlidXRlTmFtZSBpbiBhdHRyaWJ1dGVDb25maWcpIHsKICAgICAgICBpZiAoYXR0cmlidXRlQ29uZmlnLmhhc093blByb3BlcnR5KGF0dHJpYnV0ZU5hbWUpKSB7CgogICAgICAgICAgICBpZiAoaXNMZWFmTm9kZShhdHRyaWJ1dGVDb25maWdbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgICAgICAgICBhdHRyUGF0aCA9IGF0dHJpYnV0ZVBhdGguc2xpY2UoKTsKICAgICAgICAgICAgICAgIGF0dHJQYXRoLnB1c2goYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVQYXRocy5wdXNoKGF0dHJQYXRoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGF0dHJQYXRoID0gYXR0cmlidXRlUGF0aC5zbGljZSgpOwogICAgICAgICAgICAgICAgYXR0clBhdGgucHVzaChhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIGF0dHJQYXRocyA9IGdldEF0dHJpYnV0ZVBhdGhzKGF0dHJpYnV0ZUNvbmZpZ1thdHRyaWJ1dGVOYW1lXSwgYXR0clBhdGgpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGF0dHJQYXRocy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZVBhdGhzLnB1c2goYXR0clBhdGhzW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYXR0cmlidXRlUGF0aHM7Cn0KCmZ1bmN0aW9uIGdldERldmljZVByaW50QXR0cmlidXRlUGF0aHMoYXR0cmlidXRlQ29uZmlnKSB7CiAgICByZXR1cm4gZ2V0QXR0cmlidXRlUGF0aHMoYXR0cmlidXRlQ29uZmlnLCBbXSk7Cn0KCmZ1bmN0aW9uIGhhc1JlcXVpcmVkQXR0cmlidXRlcyhkZXZpY2VQcmludCwgYXR0cmlidXRlQ29uZmlnKSB7CgogICAgdmFyIGF0dHJpYnV0ZVBhdGhzID0gZ2V0RGV2aWNlUHJpbnRBdHRyaWJ1dGVQYXRocyhhdHRyaWJ1dGVDb25maWcpLAogICAgICAgIGksCiAgICAgICAgYXR0clZhbHVlLAogICAgICAgIGF0dHJDb25maWc7CgogICAgZm9yIChpID0gMDsgaSA8IGF0dHJpYnV0ZVBhdGhzLmxlbmd0aDsgaSsrKSB7CgogICAgICAgIGF0dHJWYWx1ZSA9IGdldFZhbHVlKGRldmljZVByaW50LCBhdHRyaWJ1dGVQYXRoc1tpXSk7CiAgICAgICAgYXR0ckNvbmZpZyA9IGdldFZhbHVlKGF0dHJpYnV0ZUNvbmZpZywgYXR0cmlidXRlUGF0aHNbaV0pOwoKICAgICAgICBpZiAoYXR0ckNvbmZpZy5yZXF1aXJlZCAmJiBhdHRyVmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBsb2dnZXIud2FybmluZygiRGV2aWNlIFByaW50IHByb2ZpbGUgbWlzc2luZyByZXF1aXJlZCBhdHRyaWJ1dGUsICIgKyBhdHRyaWJ1dGVQYXRoc1tpXSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgbG9nZ2VyLm1lc3NhZ2UoImRldmljZSBwcmludCBoYXMgcmVxdWlyZWQgYXR0cmlidXRlcyIpOwogICAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIGNvbXBhcmVEZXZpY2VQcmludFByb2ZpbGVzKGF0dHJpYnV0ZUNvbmZpZywgZGV2aWNlUHJpbnQsIGRldmljZVByaW50UHJvZmlsZXMsIG1heFBlbmFsdHlQb2ludHMpIHsKCiAgICB2YXIgYXR0cmlidXRlUGF0aHMgPSBnZXREZXZpY2VQcmludEF0dHJpYnV0ZVBhdGhzKGF0dHJpYnV0ZUNvbmZpZyksCiAgICAgICAgcmVzdWx0cywKICAgICAgICBqLAogICAgICAgIGFnZ3JlZ2F0ZWRDb21wYXJpc29uUmVzdWx0LAogICAgICAgIGksCiAgICAgICAgY3VycmVudFZhbHVlLAogICAgICAgIHN0b3JlZFZhbHVlLAogICAgICAgIGF0dHJDb25maWcsCiAgICAgICAgY29tcGFyaXNvblJlc3VsdCwKICAgICAgICBzZWxlY3RlZENvbXBhcmlzb25SZXN1bHQsCiAgICAgICAgc2VsZWN0ZWRQcm9maWxlLAogICAgICAgIHZhbHM7CgogICAgcmVzdWx0cyA9IFtdOwogICAgZm9yIChqID0gMDsgaiA8IGRldmljZVByaW50UHJvZmlsZXMubGVuZ3RoOyBqKyspIHsKCiAgICAgICAgYWdncmVnYXRlZENvbXBhcmlzb25SZXN1bHQgPSBuZXcgQ29tcGFyaXNvblJlc3VsdCgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBhdHRyaWJ1dGVQYXRocy5sZW5ndGg7IGkrKykgewoKICAgICAgICAgICAgY3VycmVudFZhbHVlID0gZ2V0VmFsdWUoZGV2aWNlUHJpbnQsIGF0dHJpYnV0ZVBhdGhzW2ldKTsKICAgICAgICAgICAgc3RvcmVkVmFsdWUgPSBnZXRWYWx1ZShkZXZpY2VQcmludFByb2ZpbGVzW2pdLmRldmljZVByaW50LCBhdHRyaWJ1dGVQYXRoc1tpXSk7CiAgICAgICAgICAgIGF0dHJDb25maWcgPSBnZXRWYWx1ZShhdHRyaWJ1dGVDb25maWcsIGF0dHJpYnV0ZVBhdGhzW2ldKTsKCiAgICAgICAgICAgIGlmIChzdG9yZWRWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29tcGFyaXNvblJlc3VsdCA9IG5ldyBDb21wYXJpc29uUmVzdWx0KGF0dHJDb25maWcucGVuYWx0eVBvaW50cyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21wYXJpc29uUmVzdWx0ID0gYXR0ckNvbmZpZy5jb21wYXJhdG9yLmNvbXBhcmUoY3VycmVudFZhbHVlLCBzdG9yZWRWYWx1ZSwgYXR0ckNvbmZpZy5hcmdzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgICBsb2dnZXIubWVzc2FnZSgiQ29tcGFyaW5nIGF0dHJpYnV0ZSBwYXRoOiAiICsgYXR0cmlidXRlUGF0aHNbaV0KICAgICAgICAgICAgICAgICAgICArICIsIENvbXBhcmlzb24gcmVzdWx0OiBzdWNjZXNzZnVsPSIgKyBjb21wYXJpc29uUmVzdWx0LmlzU3VjY2Vzc2Z1bCgpICsgIiwgcGVuYWx0eVBvaW50cz0iCiAgICAgICAgICAgICAgICAgICAgKyBjb21wYXJpc29uUmVzdWx0LnBlbmFsdHlQb2ludHMgKyAiLCBhZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlPSIKICAgICAgICAgICAgICAgICAgICArIGNvbXBhcmlzb25SZXN1bHQuYWRkaXRpb25hbEluZm9JbkN1cnJlbnRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWdncmVnYXRlZENvbXBhcmlzb25SZXN1bHQuYWRkQ29tcGFyaXNvblJlc3VsdChjb21wYXJpc29uUmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGxvZ2dlci5tZXNzYWdlKCJBZ2dyZWdhdGVkIGNvbXBhcmlzb24gcmVzdWx0OiBzdWNjZXNzZnVsPSIKICAgICAgICAgICAgICAgICsgYWdncmVnYXRlZENvbXBhcmlzb25SZXN1bHQuaXNTdWNjZXNzZnVsKCkgKyAiLCBwZW5hbHR5UG9pbnRzPSIKICAgICAgICAgICAgICAgICsgYWdncmVnYXRlZENvbXBhcmlzb25SZXN1bHQucGVuYWx0eVBvaW50cyArICIsIGFkZGl0aW9uYWxJbmZvSW5DdXJyZW50VmFsdWU9IgogICAgICAgICAgICAgICAgKyBhZ2dyZWdhdGVkQ29tcGFyaXNvblJlc3VsdC5hZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgICAgIGtleTogYWdncmVnYXRlZENvbXBhcmlzb25SZXN1bHQsCiAgICAgICAgICAgIHZhbHVlOiBkZXZpY2VQcmludFByb2ZpbGVzW2pdCiAgICAgICAgfSk7CiAgICB9CgogICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgcmVzdWx0cy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICByZXR1cm4gQ29tcGFyaXNvblJlc3VsdC5jb21wYXJlKGEua2V5LCBiLmtleSk7CiAgICB9KTsKICAgIHNlbGVjdGVkQ29tcGFyaXNvblJlc3VsdCA9IHJlc3VsdHNbMF0ua2V5OwogICAgaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIlNlbGVjdGVkIGNvbXBhcmlzb24gcmVzdWx0OiBzdWNjZXNzZnVsPSIgKyBzZWxlY3RlZENvbXBhcmlzb25SZXN1bHQuaXNTdWNjZXNzZnVsKCkKICAgICAgICAgICAgKyAiLCBwZW5hbHR5UG9pbnRzPSIgKyBzZWxlY3RlZENvbXBhcmlzb25SZXN1bHQucGVuYWx0eVBvaW50cyArICIsIGFkZGl0aW9uYWxJbmZvSW5DdXJyZW50VmFsdWU9IgogICAgICAgICAgICArIHNlbGVjdGVkQ29tcGFyaXNvblJlc3VsdC5hZGRpdGlvbmFsSW5mb0luQ3VycmVudFZhbHVlKTsKICAgIH0KCiAgICBzZWxlY3RlZFByb2ZpbGUgPSBudWxsOwogICAgaWYgKHNlbGVjdGVkQ29tcGFyaXNvblJlc3VsdC5wZW5hbHR5UG9pbnRzIDw9IG1heFBlbmFsdHlQb2ludHMpIHsKICAgICAgICBzZWxlY3RlZFByb2ZpbGUgPSByZXN1bHRzWzBdLnZhbHVlOwogICAgICAgIGlmIChsb2dnZXIubWVzc2FnZUVuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIubWVzc2FnZSgiU2VsZWN0ZWQgcHJvZmlsZTogIiArIEpTT04uc3RyaW5naWZ5KHNlbGVjdGVkUHJvZmlsZSkgKwogICAgICAgICAgICAgICAgIiB3aXRoICIgKyBzZWxlY3RlZENvbXBhcmlzb25SZXN1bHQucGVuYWx0eVBvaW50cyArICIgcGVuYWx0eSBwb2ludHMiKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHNlbGVjdGVkUHJvZmlsZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKiB1cGRhdGUgcHJvZmlsZSAqLwogICAgc2VsZWN0ZWRQcm9maWxlLnNlbGVjdGlvbkNvdW50ZXIgPSBzZWxlY3RlZFByb2ZpbGUuc2VsZWN0aW9uQ291bnRlciArIDE7CiAgICBzZWxlY3RlZFByb2ZpbGUubGFzdFNlbGVjdGVkRGF0ZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgc2VsZWN0ZWRQcm9maWxlLmRldmljZVByaW50ID0gZGV2aWNlUHJpbnQ7CgogICAgdmFscyA9IFtdOwogICAgZm9yIChpID0gMDsgaSA8IGRldmljZVByaW50UHJvZmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YWxzLnB1c2goSlNPTi5zdHJpbmdpZnkoZGV2aWNlUHJpbnRQcm9maWxlc1tpXSkpOwogICAgfQoKICAgIGlkUmVwb3NpdG9yeS5zZXRBdHRyaWJ1dGUodXNlcm5hbWUsICJkZXZpY2VQcmludFByb2ZpbGVzIiwgdmFscyk7CgogICAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIG1hdGNoRGV2aWNlUHJpbnQoKSB7CgogICAgaWYgKCF1c2VybmFtZSkgewogICAgICAgIGxvZ2dlci5lcnJvcigiVXNlcm5hbWUgbm90IHNldC4gQ2Fubm90IGNvbXBhcmUgdXNlcidzIGRldmljZSBwcmludCBwcm9maWxlcy4iKTsKICAgICAgICBhdXRoU3RhdGUgPSBGQUlMRUQ7CiAgICB9IGVsc2UgewoKICAgICAgICBpZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgICAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoImNsaWVudCBkZXZpY2VQcmludDogIiArIGNsaWVudFNjcmlwdE91dHB1dERhdGEpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGdldFByb2ZpbGVzID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGlzRXhwaXJlZFByb2ZpbGUoZGV2aWNlUHJpbnRQcm9maWxlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV4cGlyYXRpb25EYXRlID0gbmV3IERhdGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNlbGVjdGVkRGF0ZTsKICAgICAgICAgICAgICAgICAgICBleHBpcmF0aW9uRGF0ZS5zZXREYXRlKGV4cGlyYXRpb25EYXRlLmdldERhdGUoKSAtIGNvbmZpZy5wcm9maWxlRXhwaXJhdGlvbik7CgogICAgICAgICAgICAgICAgICAgIGxhc3RTZWxlY3RlZERhdGUgPSBuZXcgRGF0ZShkZXZpY2VQcmludFByb2ZpbGUubGFzdFNlbGVjdGVkRGF0ZSk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBsYXN0U2VsZWN0ZWREYXRlIDwgZXhwaXJhdGlvbkRhdGU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Tm90RXhwaXJlZFByb2ZpbGVzKCkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHRzID0gW10sCiAgICAgICAgICAgICAgICAgICAgICAgIHByb2ZpbGVzID0gaWRSZXBvc2l0b3J5LmdldEF0dHJpYnV0ZSh1c2VybmFtZSwgImRldmljZVByaW50UHJvZmlsZXMiKSwKICAgICAgICAgICAgICAgICAgICAgICAgaXRlciA9IHByb2ZpbGVzLml0ZXJhdG9yKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHByb2ZpbGU7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGl0ZXIuaGFzTmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2ZpbGUgPSBKU09OLnBhcnNlKGl0ZXIubmV4dCgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0V4cGlyZWRQcm9maWxlKHByb2ZpbGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2gocHJvZmlsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvZ2dlci5tZXNzYWdlRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5tZXNzYWdlKCJzdG9yZWQgbm9uLWV4cGlyZWQgcHJvZmlsZXM6ICIgKyBKU09OLnN0cmluZ2lmeShyZXN1bHRzKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBnZXROb3RFeHBpcmVkUHJvZmlsZXMoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGV2aWNlUHJpbnQgPSBKU09OLnBhcnNlKGNsaWVudFNjcmlwdE91dHB1dERhdGEpLAogICAgICAgICAgICBkZXZpY2VQcmludFByb2ZpbGVzID0gZ2V0UHJvZmlsZXMoKTsKCiAgICAgICAgaWYgKCFoYXNSZXF1aXJlZEF0dHJpYnV0ZXMoZGV2aWNlUHJpbnQsIGNvbmZpZy5hdHRyaWJ1dGVzKSkgewogICAgICAgICAgICBsb2dnZXIubWVzc2FnZSgiZGV2aWNlUHJpbnQuaGFzUmVxdWlyZWRBdHRyaWJ1dGVzOiBmYWxzZSIpOwogICAgICAgICAgICAvLyBXaWxsIGZhaWwgdGhpcyBtb2R1bGUgYnV0IGZhbGwtdGhyb3VnaCB0byBuZXh0IG1vZHVsZS4gV2hpY2ggc2hvdWxkIGJlIE9UUC4KICAgICAgICAgICAgYXV0aFN0YXRlID0gRkFJTEVEOwogICAgICAgIH0gZWxzZSBpZiAoY29tcGFyZURldmljZVByaW50UHJvZmlsZXMoY29uZmlnLmF0dHJpYnV0ZXMsIGRldmljZVByaW50LCBkZXZpY2VQcmludFByb2ZpbGVzLCBjb25maWcubWF4UGVuYWx0eVBvaW50cykpIHsKICAgICAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoImRldmljZVByaW50Lmhhc1ZhbGlkUHJvZmlsZTogdHJ1ZSIpOwogICAgICAgICAgICBhdXRoU3RhdGUgPSBTVUNDRVNTOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxvZ2dlci5tZXNzYWdlKCJkZXZpY2VQcmludC5oYXNWYWxpZFByb2ZpbGU6IGZhbHNlIik7CiAgICAgICAgICAgIHNoYXJlZFN0YXRlLnB1dCgnZGV2aWNlUHJpbnRQcm9maWxlJywgSlNPTi5zdHJpbmdpZnkoZGV2aWNlUHJpbnQpKTsKICAgICAgICAgICAgLy8gV2lsbCBmYWlsIHRoaXMgbW9kdWxlIGJ1dCBmYWxsLXRocm91Z2ggdG8gbmV4dCBtb2R1bGUuIFdoaWNoIHNob3VsZCBiZSBPVFAuCiAgICAgICAgICAgIGF1dGhTdGF0ZSA9IEZBSUxFRDsKICAgICAgICB9CiAgICB9Cn0KCm1hdGNoRGV2aWNlUHJpbnQoKTs=", "language": "JAVASCRIPT", "context": "AUTHENTICATION_SERVER_SIDE", "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "creationDate": 1433147666269, "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "lastModifiedDate": 1433147666269},
                        {"_id": "36863ffb-40ec-48b9-94b1-9a99f71cc3b5", "name": "OIDC Claims Script", "description": "Default global script for OIDC claims", "script": "LyoKKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBvZiB0aGUgQ29tbW9uIERldmVsb3BtZW50IGFuZAoqIERpc3RyaWJ1dGlvbiBMaWNlbnNlICh0aGUgTGljZW5zZSkuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUKKiBMaWNlbnNlLgoqCiogWW91IGNhbiBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0IGxlZ2FsL0NEREx2MS4wLnR4dC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUKKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCioKKiBXaGVuIGRpc3RyaWJ1dGluZyBDb3ZlcmVkIFNvZnR3YXJlLCBpbmNsdWRlIHRoaXMgQ0RETCBIZWFkZXIgTm90aWNlIGluIGVhY2ggZmlsZSBhbmQgaW5jbHVkZQoqIHRoZSBMaWNlbnNlIGZpbGUgYXQgbGVnYWwvQ0RETHYxLjAudHh0LiBJZiBhcHBsaWNhYmxlLCBhZGQgdGhlIGZvbGxvd2luZyBiZWxvdyB0aGUgQ0RETAoqIEhlYWRlciwgd2l0aCB0aGUgZmllbGRzIGVuY2xvc2VkIGJ5IGJyYWNrZXRzIFtdIHJlcGxhY2VkIGJ5IHlvdXIgb3duIGlkZW50aWZ5aW5nCiogaW5mb3JtYXRpb246ICJQb3J0aW9ucyBjb3B5cmlnaHQgW3llYXJdIFtuYW1lIG9mIGNvcHlyaWdodCBvd25lcl0iLgoqCiogQ29weXJpZ2h0IDIwMTQtMjAxNSBGb3JnZVJvY2sgQVMuCiovCmltcG9ydCBjb20uaXBsYW5ldC5zc28uU1NPRXhjZXB0aW9uCmltcG9ydCBjb20uc3VuLmlkZW50aXR5LmlkbS5JZFJlcG9FeGNlcHRpb24KCi8qCiogRGVmaW5lZCB2YXJpYWJsZXM6CiogbG9nZ2VyIC0gYWx3YXlzIHByZXNlbnRzLCB0aGUgIk9BdXRoMlByb3ZpZGVyIiBkZWJ1ZyBsb2dnZXIgaW5zdGFuY2UKKiBjbGFpbXMgLSBhbHdheXMgcHJlc2VudCwgZGVmYXVsdCBzZXJ2ZXIgcHJvdmlkZWQgY2xhaW1zCiogYWNjZXNzVG9rZW4gLSBhbHdheXMgcHJlc2VudCwgdGhlIE9BdXRoMiBhY2Nlc3MgdG9rZW4KKiBzZXNzaW9uIC0gcHJlc2VudCBpZiB0aGUgcmVxdWVzdCBjb250YWlucyB0aGUgc2Vzc2lvbiBjb29raWUsIHRoZSB1c2VyJ3Mgc2Vzc2lvbiBvYmplY3QKKiBpZGVudGl0eSAtIGFsd2F5cyBwcmVzZW50LCB0aGUgaWRlbnRpdHkgb2YgdGhlIHJlc291cmNlIG93bmVyCiogc2NvcGVzIC0gYWx3YXlzIHByZXNlbnQsIHRoZSByZXF1ZXN0ZWQgc2NvcGVzCiogcmVxdWVzdGVkQ2xhaW1zIC0gTWFwPFN0cmluZywgU2V0PFN0cmluZz4+CiogICAgICAgICAgICAgICAgICBhbHdheXMgcHJlc2VudCwgbm90IGVtcHR5IGlmIHRoZSByZXF1ZXN0IGNvbnRhaW5zIGEgY2xhaW1zIHBhcmFtZXRlciBhbmQgc2VydmVyIGhhcyBlbmFibGVkCiogICAgICAgICAgICAgICAgICBjbGFpbXNfcGFyYW1ldGVyX3N1cHBvcnRlZCwgbWFwIG9mIHJlcXVlc3RlZCBjbGFpbXMgdG8gcG9zc2libGUgdmFsdWVzLCBvdGhlcndpc2UgZW1wdHksCiogICAgICAgICAgICAgICAgICByZXF1ZXN0ZWQgY2xhaW1zIHdpdGggbm8gcmVxdWVzdGVkIHZhbHVlcyB3aWxsIGhhdmUgYSBrZXkgYnV0IG5vIHZhbHVlIGluIHRoZSBtYXAuIEEga2V5IHdpdGgKKiAgICAgICAgICAgICAgICAgIGEgc2luZ2xlIHZhbHVlIGluIGl0cyBTZXQgaW5kaWNhdGVzIHRoaXMgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBzaG91bGQgYmUgcmV0dXJuZWQuCiogUmVxdWlyZWQgdG8gcmV0dXJuIGEgTWFwIG9mIGNsYWltcyB0byBiZSBhZGRlZCB0byB0aGUgaWRfdG9rZW4gY2xhaW1zCiovCgovLyB1c2VyIHNlc3Npb24gbm90IGd1YXJhbnRlZWQgdG8gYmUgcHJlc2VudApib29sZWFuIHNlc3Npb25QcmVzZW50ID0gc2Vzc2lvbiAhPSBudWxsCgpkZWYgZnJvbVNldCA9IHsgY2xhaW0sIGF0dHIgLT4KICAgIGlmIChhdHRyICE9IG51bGwgJiYgYXR0ci5zaXplKCkgPT0gMSl7CiAgICAgICAgYXR0ci5pdGVyYXRvcigpLm5leHQoKQogICAgfSBlbHNlIGlmIChhdHRyICE9IG51bGwgJiYgYXR0ci5zaXplKCkgPiAxKXsKICAgICAgICBhdHRyCiAgICB9IGVsc2UgaWYgKGxvZ2dlci53YXJuaW5nRW5hYmxlZCgpKSB7CiAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk9wZW5BTVNjb3BlVmFsaWRhdG9yLmdldFVzZXJJbmZvKCk6IEdvdCBhbiBlbXB0eSByZXN1bHQgZm9yIGNsYWltPSRjbGFpbSIpOwogICAgfQp9CgphdHRyaWJ1dGVSZXRyaWV2ZXIgPSB7IGF0dHJpYnV0ZSwgY2xhaW0sIGlkZW50aXR5LCByZXF1ZXN0ZWQgLT4KICAgIGlmIChyZXF1ZXN0ZWQgPT0gbnVsbCB8fCByZXF1ZXN0ZWQuaXNFbXB0eSgpKSB7CiAgICAgICAgZnJvbVNldChjbGFpbSwgaWRlbnRpdHkuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZSkpCiAgICB9IGVsc2UgaWYgKHJlcXVlc3RlZC5zaXplKCkgPT0gMSkgewogICAgICAgIHJlcXVlc3RlZC5pdGVyYXRvcigpLm5leHQoKQogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgUnVudGltZUV4Y2VwdGlvbigiTm8gc2VsZWN0aW9uIGxvZ2ljIGZvciAkY2xhaW0gZGVmaW5lZC4gVmFsdWVzOiAkcmVxdWVzdGVkIikKICAgIH0KfQoKLy8gWyB7Y2xhaW19OiB7YXR0cmlidXRlIHJldHJpZXZlcn0sIC4uLiBdCmNsYWltQXR0cmlidXRlcyA9IFsKICAgICAgICAiZW1haWwiOiBhdHRyaWJ1dGVSZXRyaWV2ZXIuY3VycnkoIm1haWwiKSwKICAgICAgICAiYWRkcmVzcyI6IHsgY2xhaW0sIGlkZW50aXR5LCByZXF1ZXN0ZWQgLT4gWyAiZm9ybWF0dGVkIiA6IGF0dHJpYnV0ZVJldHJpZXZlcigicG9zdGFsYWRkcmVzcyIsIGNsYWltLCBpZGVudGl0eSwgcmVxdWVzdGVkKSBdIH0sCiAgICAgICAgInBob25lX251bWJlciI6IGF0dHJpYnV0ZVJldHJpZXZlci5jdXJyeSgidGVsZXBob25lbnVtYmVyIiksCiAgICAgICAgImdpdmVuX25hbWUiOiBhdHRyaWJ1dGVSZXRyaWV2ZXIuY3VycnkoImdpdmVubmFtZSIpLAogICAgICAgICJ6b25laW5mbyI6IGF0dHJpYnV0ZVJldHJpZXZlci5jdXJyeSgicHJlZmVycmVkdGltZXpvbmUiKSwKICAgICAgICAiZmFtaWx5X25hbWUiOiBhdHRyaWJ1dGVSZXRyaWV2ZXIuY3VycnkoInNuIiksCiAgICAgICAgImxvY2FsZSI6IGF0dHJpYnV0ZVJldHJpZXZlci5jdXJyeSgicHJlZmVycmVkbG9jYWxlIiksCiAgICAgICAgIm5hbWUiOiBhdHRyaWJ1dGVSZXRyaWV2ZXIuY3VycnkoImNuIikKXQoKLy8ge3Njb3BlfTogWyB7Y2xhaW19LCAuLi4gXQpzY29wZUNsYWltc01hcCA9IFsKICAgICAgICAiZW1haWwiOiBbICJlbWFpbCIgXSwKICAgICAgICAiYWRkcmVzcyI6IFsgImFkZHJlc3MiIF0sCiAgICAgICAgInBob25lIjogWyAicGhvbmVfbnVtYmVyIiBdLAogICAgICAgICJwcm9maWxlIjogWyAiZ2l2ZW5fbmFtZSIsICJ6b25laW5mbyIsICJmYW1pbHlfbmFtZSIsICJsb2NhbGUiLCAibmFtZSIgXQpdCgppZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgIHNjb3Blcy5maW5kQWxsIHsgcyAtPiAhKCJvcGVuaWQiLmVxdWFscyhzKSB8fCBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzKSkgfS5lYWNoIHsgcyAtPgogICAgICAgIGxvZ2dlci5tZXNzYWdlKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOjpNZXNzYWdlOiBzY29wZSBub3QgYm91bmQgdG8gY2xhaW1zOiAkcyIpCiAgICB9Cn0KCmRlZiBjb21wdXRlQ2xhaW0gPSB7IGNsYWltLCByZXF1ZXN0ZWRWYWx1ZXMgLT4KICAgIHRyeSB7CiAgICAgICAgWyBjbGFpbSwgY2xhaW1BdHRyaWJ1dGVzLmdldChjbGFpbSkoY2xhaW0sIGlkZW50aXR5LCByZXF1ZXN0ZWRWYWx1ZXMpIF0KICAgIH0gY2F0Y2ggKElkUmVwb0V4Y2VwdGlvbiBlKSB7CiAgICAgICAgaWYgKGxvZ2dlci53YXJuaW5nRW5hYmxlZCgpKSB7CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJPcGVuQU1TY29wZVZhbGlkYXRvci5nZXRVc2VySW5mbygpOiBVbmFibGUgdG8gcmV0cmlldmUgYXR0cmlidXRlPSRhdHRyaWJ1dGUiLCBlKTsKICAgICAgICB9CiAgICB9IGNhdGNoIChTU09FeGNlcHRpb24gZSkgewogICAgICAgIGlmIChsb2dnZXIud2FybmluZ0VuYWJsZWQoKSkgewogICAgICAgICAgICBsb2dnZXIud2FybmluZygiT3BlbkFNU2NvcGVWYWxpZGF0b3IuZ2V0VXNlckluZm8oKTogVW5hYmxlIHRvIHJldHJpZXZlIGF0dHJpYnV0ZT0kYXR0cmlidXRlIiwgZSk7CiAgICAgICAgfQogICAgfQp9CgpzY29wZXMuZmluZEFsbCB7IHMgLT4gISJvcGVuaWQiLmVxdWFscyhzKSAmJiBzY29wZUNsYWltc01hcC5jb250YWluc0tleShzKSB9LmluamVjdChjbGFpbXMpIHsgbWFwLCBzIC0+CiAgICBzY29wZUNsYWltcyA9IHNjb3BlQ2xhaW1zTWFwLmdldChzKQogICAgbWFwIDw8IHNjb3BlQ2xhaW1zLmZpbmRBbGwgeyBjIC0+ICFyZXF1ZXN0ZWRDbGFpbXMuY29udGFpbnNLZXkoYykgfS5jb2xsZWN0RW50cmllcyhbOl0pIHsgY2xhaW0gLT4gY29tcHV0ZUNsYWltKGNsYWltLCBudWxsKSB9Cn0uZmluZEFsbCB7IG1hcCAtPiBtYXAudmFsdWUgIT0gbnVsbCB9IDw8IHJlcXVlc3RlZENsYWltcy5jb2xsZWN0RW50cmllcyhbOl0pIHsgY2xhaW0sIHJlcXVlc3RlZFZhbHVlIC0+CiAgICBjb21wdXRlQ2xhaW0oY2xhaW0sIHJlcXVlc3RlZFZhbHVlKQp9", "language": "GROOVY", "context": "OIDC_CLAIMS", "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "creationDate": 1433147666269, "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "lastModifiedDate": 1433147666269},
                        {"_id": "862da73e-1beb-11e5-9a21-1697f925ec7b", "name": "SDK Script", "description": "Default global script for SDK", "script": "LyoKKiBUaGUgY29udGVudHMgb2YgdGhpcyBmaWxlIGFyZSBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBvZiB0aGUgQ29tbW9uIERldmVsb3BtZW50IGFuZAoqIERpc3RyaWJ1dGlvbiBMaWNlbnNlICh0aGUgTGljZW5zZSkuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUKKiBMaWNlbnNlLgoqCiogWW91IGNhbiBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0IGxlZ2FsL0NEREx2MS4wLnR4dC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUKKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCioKKiBXaGVuIGRpc3RyaWJ1dGluZyBDb3ZlcmVkIFNvZnR3YXJlLCBpbmNsdWRlIHRoaXMgQ0RETCBIZWFkZXIgTm90aWNlIGluIGVhY2ggZmlsZSBhbmQgaW5jbHVkZQoqIHRoZSBMaWNlbnNlIGZpbGUgYXQgbGVnYWwvQ0RETHYxLjAudHh0LiBJZiBhcHBsaWNhYmxlLCBhZGQgdGhlIGZvbGxvd2luZyBiZWxvdyB0aGUgQ0RETAoqIEhlYWRlciwgd2l0aCB0aGUgZmllbGRzIGVuY2xvc2VkIGJ5IGJyYWNrZXRzIFtdIHJlcGxhY2VkIGJ5IHlvdXIgb3duIGlkZW50aWZ5aW5nCiogaW5mb3JtYXRpb246ICJQb3J0aW9ucyBjb3B5cmlnaHQgW3llYXJdIFtuYW1lIG9mIGNvcHlyaWdodCBvd25lcl0iLgoqCiogQ29weXJpZ2h0IDIwMTUgRm9yZ2VSb2NrIEFTLgoqLw==", "language": "GROOVY", "context": "SDK", "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "creationDate": 1433147666269, "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "lastModifiedDate": 1433147666269},
                        {"_id": "7e3d7067-d50f-4674-8c76-a3e13a810c33", "name": "Scripted Module - Server Side", "description": "Default global script for server side Scripted Authentication Module", "script": "dmFyIFNUQVJUX1RJTUUgPSA5OyAgLy8gOWFtCnZhciBFTkRfVElNRSAgID0gMTc7IC8vIDVwbQoKbG9nZ2VyLm1lc3NhZ2UoIlN0YXJ0aW5nIGF1dGhlbnRpY2F0aW9uIGphdmFzY3JpcHQiKTsKbG9nZ2VyLm1lc3NhZ2UoIlVzZXI6ICIgKyB1c2VybmFtZSk7CgovLyBMb2cgb3V0IGN1cnJlbnQgY29va2llcyBpbiB0aGUgcmVxdWVzdAppZiAobG9nZ2VyLm1lc3NhZ2VFbmFibGVkKCkpIHsKICAgIHZhciBjb29raWVzID0gcmVxdWVzdERhdGEuZ2V0SGVhZGVycygnQ29va2llJyk7CiAgICBmb3IgKGNvb2tpZSBpbiBjb29raWVzKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoJ0Nvb2tpZTogJyArIGNvb2tpZXNbY29va2llXSk7CiAgICB9Cn0KCmlmICh1c2VybmFtZSkgewogICAgLy8gRmV0Y2ggdXNlciBpbmZvcm1hdGlvbiB2aWEgUkVTVAogICAgdmFyIHJlc3BvbnNlID0gaHR0cENsaWVudC5nZXQoImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9vcGVuYW0vanNvbi91c2Vycy8iICsgdXNlcm5hbWUsIHsKICAgICAgICBjb29raWVzIDogW10sCiAgICAgICAgaGVhZGVycyA6IFtdCiAgICB9KTsKICAgIC8vIExvZyBvdXQgcmVzcG9uc2UgZnJvbSBSRVNUIGNhbGwKICAgIGxvZ2dlci5tZXNzYWdlKCJVc2VyIFJFU1QgQ2FsbC4gU3RhdHVzOiAiICsgcmVzcG9uc2UuZ2V0U3RhdHVzQ29kZSgpICsgIiwgQm9keTogIiArIHJlc3BvbnNlLmdldEVudGl0eSgpKTsKfQoKdmFyIG5vdyA9IG5ldyBEYXRlKCk7CmxvZ2dlci5tZXNzYWdlKCJDdXJyZW50IHRpbWU6ICIgKyBub3cuZ2V0SG91cnMoKSk7CmlmIChub3cuZ2V0SG91cnMoKSA8IFNUQVJUX1RJTUUgfHwgbm93LmdldEhvdXJzKCkgPiBFTkRfVElNRSkgewogICAgbG9nZ2VyLmVycm9yKCJMb2dpbiBmb3JiaWRkZW4gb3V0c2lkZSB3b3JrIGhvdXJzISIpOwogICAgYXV0aFN0YXRlID0gRkFJTEVEOwp9IGVsc2UgewogICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhlbnRpY2F0aW9uIGFsbG93ZWQhIik7CiAgICBhdXRoU3RhdGUgPSBTVUNDRVNTOwp9", "language": "JAVASCRIPT", "context": "AUTHENTICATION_SERVER_SIDE", "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "creationDate": 1433147666269, "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "lastModifiedDate": 1433147666269},
                        {"_id": "9de3eb62-f131-4fac-a294-7bd170fd4acb", "name": "Scripted Policy Condition", "description": "Default global script for Scripted Policy Conditions", "script": "LyoqCiAqIFRoaXMgaXMgYSBQb2xpY3kgQ29uZGl0aW9uIGV4YW1wbGUgc2NyaXB0LiBJdCBkZW1vbnN0cmF0ZXMgaG93IHRvIGFjY2VzcyBhIHVzZXIncyBpbmZvcm1hdGlvbiwKICogdXNlIHRoYXQgaW5mb3JtYXRpb24gaW4gZXh0ZXJuYWwgSFRUUCBjYWxscyBhbmQgbWFrZSBhIHBvbGljeSBkZWNpc2lvbiBiYXNlZCBvbiB0aGUgb3V0Y29tZS4KICovCgp2YXIgdXNlckFkZHJlc3MsIHVzZXJJUCwgcmVzb3VyY2VIb3N0OwoKaWYgKHZhbGlkYXRlQW5kSW5pdGlhbGl6ZVBhcmFtZXRlcnMoKSkgewoKICAgIHZhciBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID0gZ2V0Q291bnRyeUZyb21Vc2VyQWRkcmVzcygpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIkNvdW50cnkgcmV0cmlldmVkIGZyb20gdXNlcidzIGFkZHJlc3M6ICIgKyBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzKTsKICAgIHZhciBjb3VudHJ5RnJvbVVzZXJJUCA9IGdldENvdW50cnlGcm9tVXNlcklQKCk7CiAgICBsb2dnZXIubWVzc2FnZSgiQ291bnRyeSByZXRyaWV2ZWQgZnJvbSB1c2VyJ3MgSVA6ICIgKyBjb3VudHJ5RnJvbVVzZXJJUCk7CiAgICB2YXIgY291bnRyeUZyb21SZXNvdXJjZVVSSSA9IGdldENvdW50cnlGcm9tUmVzb3VyY2VVUkkoKTsKICAgIGxvZ2dlci5tZXNzYWdlKCJDb3VudHJ5IHJldHJpZXZlZCBmcm9tIHJlc291cmNlIFVSSTogIiArIGNvdW50cnlGcm9tUmVzb3VyY2VVUkkpOwoKICAgIGlmIChjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID09PSBjb3VudHJ5RnJvbVVzZXJJUCAmJiBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID09PSBjb3VudHJ5RnJvbVJlc291cmNlVVJJKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhvcml6YXRpb24gU3VjY2VlZGVkIik7CiAgICAgICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiY291bnRyeU9mT3JpZ2luIiwgW2NvdW50cnlGcm9tVXNlckFkZHJlc3NdKTsKICAgICAgICBhdXRob3JpemVkID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhvcml6YXRpb24gRmFpbGVkIik7CiAgICAgICAgYXV0aG9yaXplZCA9IGZhbHNlOwogICAgfQoKfSBlbHNlIHsKICAgIGxvZ2dlci5tZXNzYWdlKCJSZXF1aXJlZCBwYXJhbWV0ZXJzIG5vdCBmb3VuZC4gQXV0aG9yaXphdGlvbiBGYWlsZWQuIik7CiAgICBhdXRob3JpemVkID0gZmFsc2U7Cn0KCi8qKgogKiBVc2UgdGhlIHVzZXIncyBhZGRyZXNzIHRvIGxvb2t1cCB0aGVpciBjb3VudHJ5IG9mIHJlc2lkZW5jZS4KICoKICogQHJldHVybnMgeyp9IFRoZSB1c2VyJ3MgY291bnRyeSBvZiByZXNpZGVuY2UuCiAqLwpmdW5jdGlvbiBnZXRDb3VudHJ5RnJvbVVzZXJBZGRyZXNzKCkgewogICAgdmFyIHJlc3BvbnNlID0gaHR0cENsaWVudC5nZXQoImh0dHA6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2dlb2NvZGUvanNvbj9hZGRyZXNzPSIgKwogICAgICAgIGVuY29kZVVSSUNvbXBvbmVudCh1c2VyQWRkcmVzcyksIHsKICAgICAgICBjb29raWVzOiBbXSwKICAgICAgICBoZWFkZXJzOiBbXQogICAgfSk7CiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIGdlb2NvZGUgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGdlb2NvZGUucmVzdWx0cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciByZXN1bHQgPSBnZW9jb2RlLnJlc3VsdHNbaV07CiAgICAgICAgdmFyIGo7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHJlc3VsdC5hZGRyZXNzX2NvbXBvbmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKHJlc3VsdC5hZGRyZXNzX2NvbXBvbmVudHNbaV0udHlwZXNbMF0gPT0gImNvdW50cnkiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmFkZHJlc3NfY29tcG9uZW50c1tpXS5sb25nX25hbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8qKgogKiBVc2UgdGhlIHVzZXIncyBJUCB0byBsb29rdXAgdGhlIGNvdW50cnkgZnJvbSB3aGljaCB0aGUgcmVxdWVzdCBvcmlnaW5hdGVkLgogKgogKiBAcmV0dXJucyB7Kn0gVGhlIGNvdW50cnkgZnJvbSB3aGljaCB0aGUgcmVxdWVzdCBvcmlnaW5hdGVkLgogKi8KZnVuY3Rpb24gZ2V0Q291bnRyeUZyb21Vc2VySVAoKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBodHRwQ2xpZW50LmdldCgiaHR0cDovL2lwLWFwaS5jb20vanNvbi8iICsgdXNlcklQLCB7CiAgICAgICAgY29va2llczogW10sCiAgICAgICAgaGVhZGVyczogW10KICAgIH0pOwogICAgbG9nUmVzcG9uc2UocmVzcG9uc2UpOwoKICAgIHZhciByZXN1bHQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIGlmIChyZXN1bHQpIHsKICAgICAgICByZXR1cm4gcmVzdWx0LmNvdW50cnk7CiAgICB9Cn0KCi8qKgogKiBVc2UgdGhlIHJlcXVlc3RlZCByZXNvdXJjZSdzIGhvc3QgbmFtZSB0byBsb29rdXAgdGhlIGNvdW50cnkgd2hlcmUgdGhlIHJlc291cmNlIGlzIGhvc3RlZC4KICoKICogQHJldHVybnMgeyp9IFRoZSBjb3VudHJ5IGluIHdoaWNoIHRoZSByZXNvdXJjZSBpcyBob3N0ZWQuCiAqLwpmdW5jdGlvbiBnZXRDb3VudHJ5RnJvbVJlc291cmNlVVJJKCkgewogICAgcmVzcG9uc2UgPSBodHRwQ2xpZW50LmdldCgiaHR0cDovL2lwLWFwaS5jb20vanNvbi8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlSG9zdCksIHsKICAgICAgICBjb29raWVzOiBbXSwKICAgICAgICBoZWFkZXJzOiBbXQogICAgfSk7CiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIHJlc3VsdCA9IEpTT04ucGFyc2UocmVzcG9uc2UuZ2V0RW50aXR5KCkpOwogICAgaWYgKHJlc3VsdCkgewogICAgICAgIHJldHVybiByZXN1bHQuY291bnRyeTsKICAgIH0KfQoKLyoqCiAqIFJldHJpZXZlIGFuZCB2YWxpZGF0ZSB0aGUgdmFyaWFibGVzIHJlcXVpcmVkIHRvIG1ha2UgdGhlIGV4dGVybmFsIEhUVFAgY2FsbHMuCiAqCiAqIEByZXR1cm5zIHtib29sZWFufSBXaWxsIGJlIHRydWUgaWYgdmFsaWRhdGlvbiB3YXMgc3VjY2Vzc2Z1bC4KICovCmZ1bmN0aW9uIHZhbGlkYXRlQW5kSW5pdGlhbGl6ZVBhcmFtZXRlcnMoKSB7CiAgICB2YXIgdXNlckFkZHJlc3NTZXQgPSBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoInBvc3RhbEFkZHJlc3MiKTsKICAgIGlmICh1c2VyQWRkcmVzc1NldCA9PSBudWxsIHx8IHVzZXJBZGRyZXNzU2V0LmlzRW1wdHkoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBhZGRyZXNzIHNwZWNpZmllZCBmb3IgdXNlcjogIiArIHVzZXJuYW1lKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB1c2VyQWRkcmVzcyA9IHVzZXJBZGRyZXNzU2V0Lml0ZXJhdG9yKCkubmV4dCgpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIlVzZXIgYWRkcmVzczogIiArIHVzZXJBZGRyZXNzKTsKCiAgICBpZiAoIWVudmlyb25tZW50KSB7CiAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk5vIGVudmlyb25tZW50IHBhcmFtZXRlcnMgc3BlY2lmaWVkIGluIHRoZSBldmFsdWF0aW9uIHJlcXVlc3QuIik7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBpcFNldCA9IGVudmlyb25tZW50LmdldCgiSVAiKTsKICAgIGlmIChpcFNldCA9PSBudWxsIHx8IGlwU2V0LmlzRW1wdHkoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBJUCBzcGVjaWZpZWQgaW4gdGhlIGV2YWx1YXRpb24gcmVxdWVzdCBlbnZpcm9ubWVudCBwYXJhbWV0ZXJzLiIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHVzZXJJUCA9IGlwU2V0Lml0ZXJhdG9yKCkubmV4dCgpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIlVzZXIgSVA6ICIgKyB1c2VySVApOwoKICAgIGlmICghcmVzb3VyY2VVUkkpIHsKICAgICAgICBsb2dnZXIud2FybmluZygiTm8gcmVzb3VyY2UgVVJJIHNwZWNpZmllZC4iKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXNvdXJjZUhvc3QgPSByZXNvdXJjZVVSSS5tYXRjaCgvXiguKjpcL1wvKSh3d3dcLik/KFtBLVphLXowLTlcLVwuXSspKDpbMC05XSspPyguKikkLylbM107CiAgICBsb2dnZXIubWVzc2FnZSgiUmVzb3VyY2UgaG9zdDogIiArIHJlc291cmNlSG9zdCk7CgogICAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIGxvZ1Jlc3BvbnNlKHJlc3BvbnNlKSB7CiAgICBsb2dnZXIubWVzc2FnZSgiVXNlciBSRVNUIENhbGwuIFN0YXR1czogIiArIHJlc3BvbnNlLmdldFN0YXR1c0NvZGUoKSArICIsIEJvZHk6ICIgKyByZXNwb25zZS5nZXRFbnRpdHkoKSk7Cn0=", "language": "JAVASCRIPT", "context": "POLICY_CONDITION", "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "creationDate": 1433147666269, "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "lastModifiedDate": 1433147666269},
                        {"_id": "3192f38e-00b1-473b-8de7-604c0f50d86d", "name": "ds", "description": null, "script": "LyoqCiAqIFRoaXMgaXMgYSBQb2xpY3kgQ29uZGl0aW9uIGV4YW1wbGUgc2NyaXB0LiBJdCBkZW1vbnN0cmF0ZXMgaG93IHRvIGFjY2VzcyBhIHVzZXIncyBpbmZvcm1hdGlvbiwKICogdXNlIHRoYXQgaW5mb3JtYXRpb24gaW4gZXh0ZXJuYWwgSFRUUCBjYWxscyBhbmQgbWFrZSBhIHBvbGljeSBkZWNpc2lvbiBiYXNlZCBvbiB0aGUgb3V0Y29tZS4KICovCgp2YXIgdXNlckFkZHJlc3MsIHVzZXJJUCwgcmVzb3VyY2VIb3N0OwoKaWYgKHZhbGlkYXRlQW5kSW5pdGlhbGl6ZVBhcmFtZXRlcnMoKSkgewoKICAgIHZhciBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID0gZ2V0Q291bnRyeUZyb21Vc2VyQWRkcmVzcygpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIkNvdW50cnkgcmV0cmlldmVkIGZyb20gdXNlcidzIGFkZHJlc3M6ICIgKyBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzKTsKICAgIHZhciBjb3VudHJ5RnJvbVVzZXJJUCA9IGdldENvdW50cnlGcm9tVXNlcklQKCk7CiAgICBsb2dnZXIubWVzc2FnZSgiQ291bnRyeSByZXRyaWV2ZWQgZnJvbSB1c2VyJ3MgSVA6ICIgKyBjb3VudHJ5RnJvbVVzZXJJUCk7CiAgICB2YXIgY291bnRyeUZyb21SZXNvdXJjZVVSSSA9IGdldENvdW50cnlGcm9tUmVzb3VyY2VVUkkoKTsKICAgIGxvZ2dlci5tZXNzYWdlKCJDb3VudHJ5IHJldHJpZXZlZCBmcm9tIHJlc291cmNlIFVSSTogIiArIGNvdW50cnlGcm9tUmVzb3VyY2VVUkkpOwoKICAgIGlmIChjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID09PSBjb3VudHJ5RnJvbVVzZXJJUCAmJiBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID09PSBjb3VudHJ5RnJvbVJlc291cmNlVVJJKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhvcml6YXRpb24gU3VjY2VlZGVkIik7CiAgICAgICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiY291bnRyeU9mT3JpZ2luIiwgW2NvdW50cnlGcm9tVXNlckFkZHJlc3NdKTsKICAgICAgICBhdXRob3JpemVkID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhvcml6YXRpb24gRmFpbGVkIik7CiAgICAgICAgYXV0aG9yaXplZCA9IGZhbHNlOwogICAgfQoKfSBlbHNlIHsKICAgIGxvZ2dlci5tZXNzYWdlKCJSZXF1aXJlZCBwYXJhbWV0ZXJzIG5vdCBmb3VuZC4gQXV0aG9yaXphdGlvbiBGYWlsZWQuIik7CiAgICBhdXRob3JpemVkID0gZmFsc2U7Cn0KCi8qKgogKiBVc2UgdGhlIHVzZXIncyBhZGRyZXNzIHRvIGxvb2t1cCB0aGVpciBjb3VudHJ5IG9mIHJlc2lkZW5jZS4KICoKICogQHJldHVybnMgeyp9IFRoZSB1c2VyJ3MgY291bnRyeSBvZiByZXNpZGVuY2UuCiAqLwpmdW5jdGlvbiBnZXRDb3VudHJ5RnJvbVVzZXJBZGRyZXNzKCkgewogICAgdmFyIHJlc3BvbnNlID0gaHR0cENsaWVudC5nZXQoImh0dHA6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2dlb2NvZGUvanNvbj9hZGRyZXNzPSIgKwogICAgICAgIGVuY29kZVVSSUNvbXBvbmVudCh1c2VyQWRkcmVzcyksIHsKICAgICAgICBjb29raWVzOiBbXSwKICAgICAgICBoZWFkZXJzOiBbXQogICAgfSk7CiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIGdlb2NvZGUgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGdlb2NvZGUucmVzdWx0cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciByZXN1bHQgPSBnZW9jb2RlLnJlc3VsdHNbaV07CiAgICAgICAgdmFyIGo7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHJlc3VsdC5hZGRyZXNzX2NvbXBvbmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKHJlc3VsdC5hZGRyZXNzX2NvbXBvbmVudHNbaV0udHlwZXNbMF0gPT0gImNvdW50cnkiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmFkZHJlc3NfY29tcG9uZW50c1tpXS5sb25nX25hbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8qKgogKiBVc2UgdGhlIHVzZXIncyBJUCB0byBsb29rdXAgdGhlIGNvdW50cnkgZnJvbSB3aGljaCB0aGUgcmVxdWVzdCBvcmlnaW5hdGVkLgogKgogKiBAcmV0dXJucyB7Kn0gVGhlIGNvdW50cnkgZnJvbSB3aGljaCB0aGUgcmVxdWVzdCBvcmlnaW5hdGVkLgogKi8KZnVuY3Rpb24gZ2V0Q291bnRyeUZyb21Vc2VySVAoKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBodHRwQ2xpZW50LmdldCgiaHR0cDovL2lwLWFwaS5jb20vanNvbi8iICsgdXNlcklQLCB7CiAgICAgICAgY29va2llczogW10sCiAgICAgICAgaGVhZGVyczogW10KICAgIH0pOwogICAgbG9nUmVzcG9uc2UocmVzcG9uc2UpOwoKICAgIHZhciByZXN1bHQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIGlmIChyZXN1bHQpIHsKICAgICAgICByZXR1cm4gcmVzdWx0LmNvdW50cnk7CiAgICB9Cn0KCi8qKgogKiBVc2UgdGhlIHJlcXVlc3RlZCByZXNvdXJjZSdzIGhvc3QgbmFtZSB0byBsb29rdXAgdGhlIGNvdW50cnkgd2hlcmUgdGhlIHJlc291cmNlIGlzIGhvc3RlZC4KICoKICogQHJldHVybnMgeyp9IFRoZSBjb3VudHJ5IGluIHdoaWNoIHRoZSByZXNvdXJjZSBpcyBob3N0ZWQuCiAqLwpmdW5jdGlvbiBnZXRDb3VudHJ5RnJvbVJlc291cmNlVVJJKCkgewogICAgcmVzcG9uc2UgPSBodHRwQ2xpZW50LmdldCgiaHR0cDovL2lwLWFwaS5jb20vanNvbi8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlSG9zdCksIHsKICAgICAgICBjb29raWVzOiBbXSwKICAgICAgICBoZWFkZXJzOiBbXQogICAgfSk7CiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIHJlc3VsdCA9IEpTT04ucGFyc2UocmVzcG9uc2UuZ2V0RW50aXR5KCkpOwogICAgaWYgKHJlc3VsdCkgewogICAgICAgIHJldHVybiByZXN1bHQuY291bnRyeTsKICAgIH0KfQoKLyoqCiAqIFJldHJpZXZlIGFuZCB2YWxpZGF0ZSB0aGUgdmFyaWFibGVzIHJlcXVpcmVkIHRvIG1ha2UgdGhlIGV4dGVybmFsIEhUVFAgY2FsbHMuCiAqCiAqIEByZXR1cm5zIHtib29sZWFufSBXaWxsIGJlIHRydWUgaWYgdmFsaWRhdGlvbiB3YXMgc3VjY2Vzc2Z1bC4KICovCmZ1bmN0aW9uIHZhbGlkYXRlQW5kSW5pdGlhbGl6ZVBhcmFtZXRlcnMoKSB7CiAgICB2YXIgdXNlckFkZHJlc3NTZXQgPSBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoInBvc3RhbEFkZHJlc3MiKTsKICAgIGlmICh1c2VyQWRkcmVzc1NldCA9PSBudWxsIHx8IHVzZXJBZGRyZXNzU2V0LmlzRW1wdHkoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBhZGRyZXNzIHNwZWNpZmllZCBmb3IgdXNlcjogIiArIHVzZXJuYW1lKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB1c2VyQWRkcmVzcyA9IHVzZXJBZGRyZXNzU2V0Lml0ZXJhdG9yKCkubmV4dCgpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIlVzZXIgYWRkcmVzczogIiArIHVzZXJBZGRyZXNzKTsKCiAgICBpZiAoIWVudmlyb25tZW50KSB7CiAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk5vIGVudmlyb25tZW50IHBhcmFtZXRlcnMgc3BlY2lmaWVkIGluIHRoZSBldmFsdWF0aW9uIHJlcXVlc3QuIik7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBpcFNldCA9IGVudmlyb25tZW50LmdldCgiSVAiKTsKICAgIGlmIChpcFNldCA9PSBudWxsIHx8IGlwU2V0LmlzRW1wdHkoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBJUCBzcGVjaWZpZWQgaW4gdGhlIGV2YWx1YXRpb24gcmVxdWVzdCBlbnZpcm9ubWVudCBwYXJhbWV0ZXJzLiIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHVzZXJJUCA9IGlwU2V0Lml0ZXJhdG9yKCkubmV4dCgpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIlVzZXIgSVA6ICIgKyB1c2VySVApOwoKICAgIGlmICghcmVzb3VyY2VVUkkpIHsKICAgICAgICBsb2dnZXIud2FybmluZygiTm8gcmVzb3VyY2UgVVJJIHNwZWNpZmllZC4iKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXNvdXJjZUhvc3QgPSByZXNvdXJjZVVSSS5tYXRjaCgvXiguKjpcL1wvKSh3d3dcLik/KFtBLVphLXowLTlcLVwuXSspKDpbMC05XSspPyguKikkLylbM107CiAgICBsb2dnZXIubWVzc2FnZSgiUmVzb3VyY2UgaG9zdDogIiArIHJlc291cmNlSG9zdCk7CgogICAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIGxvZ1Jlc3BvbnNlKHJlc3BvbnNlKSB7CiAgICBsb2dnZXIubWVzc2FnZSgiVXNlciBSRVNUIENhbGwuIFN0YXR1czogIiArIHJlc3BvbnNlLmdldFN0YXR1c0NvZGUoKSArICIsIEJvZHk6ICIgKyByZXNwb25zZS5nZXRFbnRpdHkoKSk7Cn0=", "language": "JAVASCRIPT", "context": "POLICY_CONDITION", "createdBy": "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org", "creationDate": 1438786275554, "lastModifiedBy": "id=amadmin,ou=user,dc=openam,dc=forgerock,dc=org", "lastModifiedDate": 1438786275554}
                    ], "resultCount": 7, "pagedResultsCookie": null, "remainingPagedResults": 0}
                )
            ]
        );

        server.respondWith(
            "GET",
            /\/json\/global-config\/services\/scripting$/,
            [
                200,
                { },
                JSON.stringify(
                    {
                        "defaults": {},
                        "defaultContext": "POLICY_CONDITION"
                    }
                )
            ]
        );

        server.respondWith(
            "GET",
            /\/json\/scripts\/9de3eb62-f131-4fac-a294-7bd170fd4acb/,
            [
                200,
                { },
                JSON.stringify({
                    "_id": "9de3eb62-f131-4fac-a294-7bd170fd4acb",
                    "name": "Scripted Policy Condition",
                    "description": "Default global script for Scripted Policy Conditions",
                    "script": "LyoqCiAqIFRoaXMgaXMgYSBQb2xpY3kgQ29uZGl0aW9uIGV4YW1wbGUgc2NyaXB0LiBJdCBkZW1vbnN0cmF0ZXMgaG93IHRvIGFjY2VzcyBhIHVzZXIncyBpbmZvcm1hdGlvbiwKICogdXNlIHRoYXQgaW5mb3JtYXRpb24gaW4gZXh0ZXJuYWwgSFRUUCBjYWxscyBhbmQgbWFrZSBhIHBvbGljeSBkZWNpc2lvbiBiYXNlZCBvbiB0aGUgb3V0Y29tZS4KICovCgp2YXIgdXNlckFkZHJlc3MsIHVzZXJJUCwgcmVzb3VyY2VIb3N0OwoKaWYgKHZhbGlkYXRlQW5kSW5pdGlhbGl6ZVBhcmFtZXRlcnMoKSkgewoKICAgIHZhciBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID0gZ2V0Q291bnRyeUZyb21Vc2VyQWRkcmVzcygpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIkNvdW50cnkgcmV0cmlldmVkIGZyb20gdXNlcidzIGFkZHJlc3M6ICIgKyBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzKTsKICAgIHZhciBjb3VudHJ5RnJvbVVzZXJJUCA9IGdldENvdW50cnlGcm9tVXNlcklQKCk7CiAgICBsb2dnZXIubWVzc2FnZSgiQ291bnRyeSByZXRyaWV2ZWQgZnJvbSB1c2VyJ3MgSVA6ICIgKyBjb3VudHJ5RnJvbVVzZXJJUCk7CiAgICB2YXIgY291bnRyeUZyb21SZXNvdXJjZVVSSSA9IGdldENvdW50cnlGcm9tUmVzb3VyY2VVUkkoKTsKICAgIGxvZ2dlci5tZXNzYWdlKCJDb3VudHJ5IHJldHJpZXZlZCBmcm9tIHJlc291cmNlIFVSSTogIiArIGNvdW50cnlGcm9tUmVzb3VyY2VVUkkpOwoKICAgIGlmIChjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID09PSBjb3VudHJ5RnJvbVVzZXJJUCAmJiBjb3VudHJ5RnJvbVVzZXJBZGRyZXNzID09PSBjb3VudHJ5RnJvbVJlc291cmNlVVJJKSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhvcml6YXRpb24gU3VjY2VlZGVkIik7CiAgICAgICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiY291bnRyeU9mT3JpZ2luIiwgW2NvdW50cnlGcm9tVXNlckFkZHJlc3NdKTsKICAgICAgICBhdXRob3JpemVkID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgbG9nZ2VyLm1lc3NhZ2UoIkF1dGhvcml6YXRpb24gRmFpbGVkIik7CiAgICAgICAgYXV0aG9yaXplZCA9IGZhbHNlOwogICAgfQoKfSBlbHNlIHsKICAgIGxvZ2dlci5tZXNzYWdlKCJSZXF1aXJlZCBwYXJhbWV0ZXJzIG5vdCBmb3VuZC4gQXV0aG9yaXphdGlvbiBGYWlsZWQuIik7CiAgICBhdXRob3JpemVkID0gZmFsc2U7Cn0KCi8qKgogKiBVc2UgdGhlIHVzZXIncyBhZGRyZXNzIHRvIGxvb2t1cCB0aGVpciBjb3VudHJ5IG9mIHJlc2lkZW5jZS4KICoKICogQHJldHVybnMgeyp9IFRoZSB1c2VyJ3MgY291bnRyeSBvZiByZXNpZGVuY2UuCiAqLwpmdW5jdGlvbiBnZXRDb3VudHJ5RnJvbVVzZXJBZGRyZXNzKCkgewogICAgdmFyIHJlc3BvbnNlID0gaHR0cENsaWVudC5nZXQoImh0dHA6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2dlb2NvZGUvanNvbj9hZGRyZXNzPSIgKwogICAgICAgIGVuY29kZVVSSUNvbXBvbmVudCh1c2VyQWRkcmVzcyksIHsKICAgICAgICBjb29raWVzOiBbXSwKICAgICAgICBoZWFkZXJzOiBbXQogICAgfSk7CiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIGdlb2NvZGUgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IGdlb2NvZGUucmVzdWx0cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciByZXN1bHQgPSBnZW9jb2RlLnJlc3VsdHNbaV07CiAgICAgICAgdmFyIGo7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHJlc3VsdC5hZGRyZXNzX2NvbXBvbmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKHJlc3VsdC5hZGRyZXNzX2NvbXBvbmVudHNbaV0udHlwZXNbMF0gPT0gImNvdW50cnkiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmFkZHJlc3NfY29tcG9uZW50c1tpXS5sb25nX25hbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8qKgogKiBVc2UgdGhlIHVzZXIncyBJUCB0byBsb29rdXAgdGhlIGNvdW50cnkgZnJvbSB3aGljaCB0aGUgcmVxdWVzdCBvcmlnaW5hdGVkLgogKgogKiBAcmV0dXJucyB7Kn0gVGhlIGNvdW50cnkgZnJvbSB3aGljaCB0aGUgcmVxdWVzdCBvcmlnaW5hdGVkLgogKi8KZnVuY3Rpb24gZ2V0Q291bnRyeUZyb21Vc2VySVAoKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBodHRwQ2xpZW50LmdldCgiaHR0cDovL2lwLWFwaS5jb20vanNvbi8iICsgdXNlcklQLCB7CiAgICAgICAgY29va2llczogW10sCiAgICAgICAgaGVhZGVyczogW10KICAgIH0pOwogICAgbG9nUmVzcG9uc2UocmVzcG9uc2UpOwoKICAgIHZhciByZXN1bHQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIGlmIChyZXN1bHQpIHsKICAgICAgICByZXR1cm4gcmVzdWx0LmNvdW50cnk7CiAgICB9Cn0KCi8qKgogKiBVc2UgdGhlIHJlcXVlc3RlZCByZXNvdXJjZSdzIGhvc3QgbmFtZSB0byBsb29rdXAgdGhlIGNvdW50cnkgd2hlcmUgdGhlIHJlc291cmNlIGlzIGhvc3RlZC4KICoKICogQHJldHVybnMgeyp9IFRoZSBjb3VudHJ5IGluIHdoaWNoIHRoZSByZXNvdXJjZSBpcyBob3N0ZWQuCiAqLwpmdW5jdGlvbiBnZXRDb3VudHJ5RnJvbVJlc291cmNlVVJJKCkgewogICAgcmVzcG9uc2UgPSBodHRwQ2xpZW50LmdldCgiaHR0cDovL2lwLWFwaS5jb20vanNvbi8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlSG9zdCksIHsKICAgICAgICBjb29raWVzOiBbXSwKICAgICAgICBoZWFkZXJzOiBbXQogICAgfSk7CiAgICBsb2dSZXNwb25zZShyZXNwb25zZSk7CgogICAgdmFyIHJlc3VsdCA9IEpTT04ucGFyc2UocmVzcG9uc2UuZ2V0RW50aXR5KCkpOwogICAgaWYgKHJlc3VsdCkgewogICAgICAgIHJldHVybiByZXN1bHQuY291bnRyeTsKICAgIH0KfQoKLyoqCiAqIFJldHJpZXZlIGFuZCB2YWxpZGF0ZSB0aGUgdmFyaWFibGVzIHJlcXVpcmVkIHRvIG1ha2UgdGhlIGV4dGVybmFsIEhUVFAgY2FsbHMuCiAqCiAqIEByZXR1cm5zIHtib29sZWFufSBXaWxsIGJlIHRydWUgaWYgdmFsaWRhdGlvbiB3YXMgc3VjY2Vzc2Z1bC4KICovCmZ1bmN0aW9uIHZhbGlkYXRlQW5kSW5pdGlhbGl6ZVBhcmFtZXRlcnMoKSB7CiAgICB2YXIgdXNlckFkZHJlc3NTZXQgPSBpZGVudGl0eS5nZXRBdHRyaWJ1dGUoInBvc3RhbEFkZHJlc3MiKTsKICAgIGlmICh1c2VyQWRkcmVzc1NldCA9PSBudWxsIHx8IHVzZXJBZGRyZXNzU2V0LmlzRW1wdHkoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBhZGRyZXNzIHNwZWNpZmllZCBmb3IgdXNlcjogIiArIHVzZXJuYW1lKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB1c2VyQWRkcmVzcyA9IHVzZXJBZGRyZXNzU2V0Lml0ZXJhdG9yKCkubmV4dCgpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIlVzZXIgYWRkcmVzczogIiArIHVzZXJBZGRyZXNzKTsKCiAgICBpZiAoIWVudmlyb25tZW50KSB7CiAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk5vIGVudmlyb25tZW50IHBhcmFtZXRlcnMgc3BlY2lmaWVkIGluIHRoZSBldmFsdWF0aW9uIHJlcXVlc3QuIik7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBpcFNldCA9IGVudmlyb25tZW50LmdldCgiSVAiKTsKICAgIGlmIChpcFNldCA9PSBudWxsIHx8IGlwU2V0LmlzRW1wdHkoKSkgewogICAgICAgIGxvZ2dlci53YXJuaW5nKCJObyBJUCBzcGVjaWZpZWQgaW4gdGhlIGV2YWx1YXRpb24gcmVxdWVzdCBlbnZpcm9ubWVudCBwYXJhbWV0ZXJzLiIpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHVzZXJJUCA9IGlwU2V0Lml0ZXJhdG9yKCkubmV4dCgpOwogICAgbG9nZ2VyLm1lc3NhZ2UoIlVzZXIgSVA6ICIgKyB1c2VySVApOwoKICAgIGlmICghcmVzb3VyY2VVUkkpIHsKICAgICAgICBsb2dnZXIud2FybmluZygiTm8gcmVzb3VyY2UgVVJJIHNwZWNpZmllZC4iKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXNvdXJjZUhvc3QgPSByZXNvdXJjZVVSSS5tYXRjaCgvXiguKjpcL1wvKSh3d3dcLik/KFtBLVphLXowLTlcLVwuXSspKDpbMC05XSspPyguKikkLylbM107CiAgICBsb2dnZXIubWVzc2FnZSgiUmVzb3VyY2UgaG9zdDogIiArIHJlc291cmNlSG9zdCk7CgogICAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIGxvZ1Jlc3BvbnNlKHJlc3BvbnNlKSB7CiAgICBsb2dnZXIubWVzc2FnZSgiVXNlciBSRVNUIENhbGwuIFN0YXR1czogIiArIHJlc3BvbnNlLmdldFN0YXR1c0NvZGUoKSArICIsIEJvZHk6ICIgKyByZXNwb25zZS5nZXRFbnRpdHkoKSk7Cn0=", "language": "JAVASCRIPT", "context": "POLICY_CONDITION", "createdBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "creationDate": 1433147666269, "lastModifiedBy": "id=dsameuser,ou=user,dc=openam,dc=forgerock,dc=org", "lastModifiedDate": 1433147666269})
            ]
        );

        server.respondWith(
            "POST",
            /\/json\/scripts\/\?_action=validate/,
            [
                200,
                { },
                JSON.stringify({"success": true})
            ]
        );
    };
});
