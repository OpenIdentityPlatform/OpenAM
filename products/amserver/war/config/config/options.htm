<script type="text/javascript">
    YAHOO.namespace("sun.identity.config.options");

    var ie7fix = 1;

    var okImage = '<img class="pointer" src="$context/assets/images/ok.jpg">';
    var okString = okImage + '<small>$page.getLocalizedString("ok.string")</small>';
    var errorImage = '<img class="pointer" src="$context/assets/images/error.jpg">';
    var warningImage = '<img class="pointer" src="$context/assets/images/warning.jpg">';
    var userStoreChoice;
    
    //convenient alias:
    var $ = YAHOO.util.Dom.get;

    function launchConsole() {
        document.location = "$context/UI/Login";
    }

    /* #if ( $upgrade )
     */

    function downloadInstructions() {
        /* TODO - enable download - where does this file reside? */
        alert( "Not implemented!" );
    }

    function onUpgradeOlderResponse( response ) {
        //for now, these methods are the same:
        onCoexistResponse( response );
    }
    function upgradeOlder() {
        YAHOO.sun.identity.config.options.upgrading.show();
        AjaxUtils.call( "$context$path?actionLink=olderUpgradeLink", onUpgradeOlderResponse );
    }

    function onCoexistResponse( response ) {
        if ( response.responseText == "true" ) {
            //operation was successful, hide the writing dialog, show the confComplete:

            //in actuality, this usually happens very fast, so put a delay when removing the testUrlPanel.
            //if we don't do this, the window blinks and looks unsightly, so we actually impose an unnecessary
            //gui delay for a slightly cleaner 'expected' UI experience:
            setTimeout("YAHOO.sun.identity.config.options.upgrading.hide()", 1500);
            setTimeout("YAHOO.sun.identity.config.options.upgradePartiallyComplete.show()", 1500);
        } else {
            //TODO - show a specific (nice looking) error message dialog that explains why the upgrade failed.
            //for now, just alert:
            alert( "Unexpected error: [" + response.responseText + "].  Please contact your System " +
                   "Administrator.  If you are the System Administrator, please direct your questions to the " +
                   "OpenSSO user's mailing list for help.");
        }
    }
    function coexist() {
        YAHOO.sun.identity.config.options.upgrading.show();
        AjaxUtils.call( "$context$path?actionLink=coexistLink", onCoexistResponse );
    }

    function onUpgradeResponse( response ) {
        if ( response.responseText == "true" ) {
            //operation was successful, hide the writing dialog, show the confComplete:

            //in actuality, this usually happens very fast, so put a delay when removing the testUrlPanel.
            //if we don't do this, the window blinks and looks unsightly, so we actually impose an unnecessary
            //gui delay for a slightly cleaner 'expected' UI experience:
            setTimeout("YAHOO.sun.identity.config.options.upgrading.hide()", 1500);
            setTimeout("YAHOO.sun.identity.config.options.upgradeComplete.show()", 1500);
        } else {
            //TODO - show a specific (nice looking) error message dialog that explains why the upgrade failed.
            //for now, just alert:
            alert( "Unexpected error: [" + response.responseText + "].  Please contact your System " +
                   "Administrator.  If you are the System Administrator, please direct your questions to the " +
                   "OpenSSO user's mailing list for help.");
        }

    }
    function upgrade() {
        YAHOO.sun.identity.config.options.confirmUpgrade.hide();
        YAHOO.sun.identity.config.options.upgrading.show();
        AjaxUtils.call( "$context$path?actionLink=upgradeLink", onUpgradeResponse );
    }
    function showConfirmUpgradePanel() {
        YAHOO.sun.identity.config.options.confirmUpgrade.show();
    }
    function cancelUpgrade() {
        YAHOO.sun.identity.config.options.confirmUpgrade.hide();
    }
    /* #else
     */
    var passwordUpdateRequired = $passwordUpdateRequired;
    var configOption = 0;

    
    function onDefaultSummarySuccess( response ) {
        var formError = (response != null && (response.getResponseHeader["formError"] != null));
        YAHOO.sun.identity.config.options.inProgress.hide();
        if ( !formError ) {            
            YAHOO.sun.identity.config.options.defaultSummary.hide(); 
            YAHOO.sun.identity.config.options.confComplete.show();
        } else {
        
            YAHOO.sun.identity.config.options.defaultSummary.show();
        }
    }
    
    function cancelDefaultSummary() {
        YAHOO.sun.identity.config.options.defaultSummary.hide();
    }

    function onDefaultSummaryFailure(response ) {
        YAHOO.sun.identity.config.options.defaultSummary.hide();
        alert("configuration failed");
        document.location = "$context/config/options.htm";
    }
        
    function submitDefaultSummaryForm() {
        YAHOO.sun.identity.config.options.defaultSummary.hide(); 
        if ( window.frames['progressIframe'] ) {
            window.frames['progressIframe'].location = "$context/setup/setSetupProgress";
        }
        YAHOO.sun.identity.config.options.inProgress.show();

        AjaxUtils.doPost("defaultSummary", "$context/config/defaultSummary.htm?" + getLocale(), AjaxUtils.serializeForm("defaultForm"), onDefaultSummarySuccess, onDefaultSummaryFailure);
    }

    function getLocale() {
        var queryString = window.top.location.search.substring(1);
        var locale = 'locale=';
        var localeValue = '';
        if (queryString.length > 0) {
            var idx = queryString.indexOf(locale);
            if (idx != -1) {
                idx += locale.length;
                var idx1 = queryString.indexOf('&', idx);
                if (idx1 == -1) {
                    idx1 = queryString.length;
                }
                localeValue = queryString.substring (idx, idx1);
            }
        }
        return locale + localeValue;
    }

    function renderDefaultSummary() {
        YAHOO.sun.identity.config.options.defaultSummary = new YAHOO.widget.Panel("defaultSummary", { width:"450px", fixedcenter: false, modal: true, close: true, visible:false, constraintoviewport:false });
        YAHOO.sun.identity.config.options.defaultSummary.render();
        YAHOO.sun.identity.config.options.defaultSummary.center();
    }
    
    
    function onNewPasswordSubmitSuccess( response ) {
        var formError = (response != null && (response.getResponseHeader["formError"] != null));
        if ( !formError ) {
            YAHOO.sun.identity.config.options.passwordDialog.hide();
            passwordUpdateRequired = false;
            if ( configOption == 1 ) {
                document.location = '$context/config/defaultSummary.htm?' + getLocale();
            } else if ( configOption == 2 ) {
                YAHOO.sun.identity.config.options.wizard.show();
            } else if ( configOption == 3 ) {
                document.location = '$context/config/existConf.htm';
            }
        }
    }
    
    function showWizard() {
        renderWizard();
        YAHOO.sun.identity.config.options.wizard.show();
    }

    function renderWizard() {
        YAHOO.sun.identity.config.options.wizard = new YAHOO.widget.Panel("wizard", { fixedcenter: false, modal: true, close: true, visible:false, constraintoviewport:true });
        YAHOO.sun.identity.config.options.wizard.render();
        YAHOO.sun.identity.config.options.wizard.center();
    }
    
    function setOption(inOption) {
        configOption = inOption;
        AjaxUtils.call( "$context$path?actionLink=resetSessionAttributes",
            onSetOption);
    }

    function onSetOption(response) {
        if (configOption == 1) {
            YAHOO.sun.identity.config.options.defaultSummary.show();
        } else if (configOption == 2) {
            YAHOO.sun.identity.config.options.wizard.show();            
        } else {
            alert("Not Implemented Yet");
        }
    }    
    
    /* #end
     */
     
    function writeConfigResponse(response) {
        if (response.responseText == "true") {              
            YAHOO.sun.identity.config.options.inProgress.hide();
            YAHOO.sun.identity.config.options.confComplete.show();
        } else {
	    document.getElementById("returnToConfig").style.display = "";
	    document.getElementById("setupMessage").innerHTML = errorImage + "&nbsp;" + response.responseText;
        }
    }
    
    var isProgressShow = false;
    function toggleProgressDiv() {
        var obj = document.getElementById("progressControl"); 
        var obj1 = document.getElementById("progressDiv"); 
        if (isProgressShow == true ) {
            obj.innerHTML = "Show Progress";
            obj1.style.display ="none";
            isProgressShow = false;
        } else {
            obj.innerHTML = "Hide progress log";
            obj1.style.display="block";
            isProgressShow = true;
        }
    }   

    function init() {
        YAHOO.sun.identity.config.options.inProgress = new YAHOO.widget.Panel("inProgress", { width:"700px", fixedcenter: false, modal:true, close: false, visible:false, constraintoviewport:true });
        YAHOO.sun.identity.config.options.inProgress.render();
        YAHOO.sun.identity.config.options.inProgress.center();
        
        YAHOO.sun.identity.config.options.confComplete = new YAHOO.widget.Panel("confComplete", { fixedcenter: false, modal:true, close: false, visible:false, constraintoviewport:true });
        YAHOO.sun.identity.config.options.confComplete.render();
        YAHOO.sun.identity.config.options.confComplete.center();
        /* #if ( $upgrade )
         */
        YAHOO.sun.identity.config.options.confirmUpgrade = new YAHOO.widget.Panel("confirmUpgrade", { fixedcenter: true, modal: true, close: false, visible:false, constraintoviewport:true });
        YAHOO.sun.identity.config.options.confirmUpgrade.render();

        YAHOO.sun.identity.config.options.upgradePartiallyComplete = new YAHOO.widget.Panel("upgradePartiallyComplete", { fixedcenter: true, modal: true, close: false, visible:false, constraintoviewport:true });
        YAHOO.sun.identity.config.options.upgradePartiallyComplete.render();

        YAHOO.sun.identity.config.options.upgradeComplete = new YAHOO.widget.Panel("upgradeComplete", { fixedcenter: true, modal: true, close: false, visible:false, constraintoviewport:true });
        YAHOO.sun.identity.config.options.upgradeComplete.render();

        YAHOO.sun.identity.config.options.upgrading = new YAHOO.widget.Panel("upgrading", { width:"240px", fixedcenter:true, close:false, draggable:false, zindex:4, modal:true, visible:false });
        YAHOO.sun.identity.config.options.upgrading.setHeader("Upgrading configuration.  Please wait...");
        YAHOO.sun.identity.config.options.upgrading.setBody('<img src="$context/assets/images/rel_interstitial_loading.gif" />');
        YAHOO.sun.identity.config.options.upgrading.render(document.body);

        YAHOO.util.Event.addListener("upgradeLink", "click", showConfirmUpgradePanel );
        YAHOO.util.Event.addListener("confirmUpgradeLink", "click", upgrade );
        YAHOO.util.Event.addListener("cancelUpgradeLink", "click", cancelUpgrade );

        YAHOO.util.Event.addListener("coexistLink", "click", coexist );
        YAHOO.util.Event.addListener("upgradeOlderLink", "click", upgradeOlder );

        YAHOO.util.Event.addListener("downloadInstructionsLink", "click", downloadInstructions );

        YAHOO.util.Event.addListener("launchConsoleLink1", "click", launchConsole );
        YAHOO.util.Event.addListener("launchConsoleLink2", "click", launchConsole );

        /* #else 
        */
        AjaxUtils.load('defaultSummaryContainer', "$context/config/defaultSummary.htm?" + getLocale(), renderDefaultSummary);
        AjaxUtils.load('wizardContainer', "$context/config/wizard/wizard.htm?" + getLocale(), renderWizard);
        /* #end
        */
    }        
        
    YAHOO.util.Event.onDOMReady(init);
</script>

<link rel="stylesheet" type="text/css" href="$context/assets/css/Specific/optionUpgrade.css" />

<div id="container" align="center">
    
    <div id="options" align="left" style="width:600px">
        #if ( $upgrade )
        <h1>$page.getLocalizedString("upgrade.available")</h1>
        <h4>$page.getLocalizedString("upgrade.available.option")</h4>
        #else
        <h1>$page.getLocalizedString("configuration.options.title")</h1>
        <h4>$page.getLocalizedString("configuration.options.subtitle")</h4>
        #end

        <div class="borderRight">
            #if ($upgrade)
            <h3>$page.getLocalizedString("upgrade.title")</h3>
	    $page.getLocalizedString("upgrade.description")
            <a id="upgradeLink" class="blue pointer">$page.getLocalizedString("upgrade.link")</a>
            #else
            <h3>$page.getLocalizedString("configuration.options.option1.title")</h3>
            $page.getLocalizedString("configuration.options.option1.description")
	    <br>
            <p>
            <a id="DemoConfiguration" class="blue pointer" onclick="setOption(1);">$page.getLocalizedString("configuration.options.option1.link")</a>
            </p>
            #end
        </div>
	<!-- enable if adding third option
        <div class="borderRight">
	-->
        <div>
            #if($upgrade)
            <h3>$page.getLocalizedString("upgrade.existing.title")</h3>
	    $page.getLocalizedString("upgrade.existing.description")
            <a id="coexistLink" class="blue pointer">$page.getLocalizedString("upgrade.existing.link")</a>
            #else
            <h3>$page.getLocalizedString("configuration.options.option2.title")</h3>
	    $page.getLocalizedString("configuration.options.option2.description")
	    <br>
            <p>
            <a id="CreateNewConf" class="blue pointer" onclick="setOption(2);">$page.getLocalizedString("configuration.options.option2.link")</a>
            </p>
            #end
        </div>
        <!--
        <div>
            #if( $upgrade )
            <h3>$page.getLocalizedString("upgrade.older.title")</h3>
	    $page.getLocalizedString("upgrade.older.description")
            <a id="upgradeOlderLink" class="blue pointer">$page.getLocalizedString("upgrade.older.link")</a>
            #else
            <h3>$page.getLocalizedString("configuration.options.option3.title")</h3>
            $page.getLocalizedString("configuration.options.option3.description");
            <a id="ExistingConfiguration" class="blue pointer" onclick="setOption(3);">$page.getLocalizedString("configuration.options.option3.link")</a>
            #end
        </div>
	-->
        
    </div>
</div>
#if ( $upgrade )
<style type="text/css">
	div.colum{
		width:280px;
		float:left;
		padding:5px;
		text-align:left;
	}
</style>
<div id="confirmUpgrade" align="center" style="width:600px;visibility:hidden">
    <div class="header">$page.getLocalizedString("upgrade.confirm.header")</div>
    <div class="bd" style="background-color: white; height: 150px">
	<h2>$page.getLocalizedString("upgrade.confirm.body")</h2>
        <div class="colum">
            <p>$page.getLocalizedString("upgrade.confirm.yes")</p>
	    <a id="confirmUpgradeLink" class="blueSmall pointer">$page.getLocalizedString("upgrade.confirm.yes.link")</a>
	</div>
	<div class="colum">
            <p>$page.getLocalizedString("upgrade.confirm.no")</p>
            <a id="cancelUpgradeLink" class="blueSmall pointer">$page.getLocalizedString("upgrade.confirm.no.link")</a>
        </div>
    </div>
</div>
<div id="upgradePartiallyComplete" style="width:400px;visibility:hidden">
    <div class="header">Upgrade Complete!</div>
    <div class="bd" style="background-color: white">
	    <h2>$page.getLocalizedString("upgrade.option.complete.title")</h2>
	    $page.getLocalizedString("upgrade.option.complete.description")
	    <p align="center" class="blue">
            <a id="downloadInstructionsLink" class="blueSmall pointer">$page.getLocalizedString("download.instructions.link")</a> |
            <a id="launchConsoleLink1" class="blueSmall pointer">$page.getLocalizedString("launch.console.link")</a>
        </p>
    </div>
</div>
<div id="upgradeComplete" style="width:400px;visibility:hidden">
    <div class="header">$page.getLocalizedString("upgrade.option.complete.title")</div>
    <div class="bd" style="background-color: white; text-align: center">
	    <h2>$page.getLocalizedString("upgrade.option.complete.body")</h2>
	    <a id="launchConsoleLink2" class="blueSmall pointer">$page.getLocalizedString("launch.console.link")</a>
    </div>
</div>
#else
    <div id="passwordDialogContainer"></div>
    <div id="defaultSummaryContainer"></div>
    <div id="wizardContainer"></div>
    
    <div id="inProgress" style="visibility:hidden">
        <div class="header"> </div>
        <div class="bd">
            <div class="bodyPopup borderPopUpGray" align="center" style="background:#FFFFFF">
                <br/>
                <h2>$page.getLocalizedString("configurator.progress")</h2>
                <img src="$context/assets/images/rel_interstitial_loading.gif" />

 <br>

                <div id="progressDiv">
                   <iframe id="progressIframe" name="progressIframe"  src="$context/assets/images/rel_interstitial_loading.gif" height=220 width=600 scrolling="no" frameborder="0">This browser cannot dipslay iframes.</iframe>
                </div>
               	<br>
		<hr>
		<br> <br>
		<span id="setupMessage"></span>
		<br>
		<br>
		<div id="returnToConfig">
                    <a href="#" onClick="YAHOO.sun.identity.config.options.inProgress.hide(); return false;">$page.getLocalizedString("return.config.link")</a>
		</div>
		<br>
            </div>
        </div>
    </div>
    
    <div id="confComplete" style="visibility:hidden">
        <div class="header">$page.getLocalizedString("configuration.option1.complete.header")</div>
        <div class="bd">
            <div class="bodyPopup borderPopUpGray" align="center" style="background:#FFFFFF">

                <br>
                <h1>$page.getLocalizedString("configuration.option1.complete.message")</h1>
                <br/>
                <p align="center" class="blueSmall">
                    <a href="#" onclick="launchConsole(); return false">$page.getLocalizedString("go.to.login.screen")</a>
                </div>
        </div>
    </div>
#end

